<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Lager App (Offline)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000000">
<style>
/* ================================================= */
/* BASIS-STYLES und MOBILE LAYOUT */
/* ================================================= */

body{
  margin:0;
  background:#000;
  color:white;
  font-family:Arial,sans-serif;
  overflow:hidden;
  overscroll-behavior:none;
}

#topbar{
  position:fixed;top:0;left:0;right:0;
  padding:15px;
  background:#000;
  z-index:5000;
  border-bottom:2px solid #333;
}
#counterWrapper{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}
.counter-box{
  padding:10px;
  border:1px solid #444;
  border-radius:10px;
  background:#000;
}
.counter-title{font-size:11px;color:#bbb;}
.counter-value{font-size:18px;font-weight:bold;}

#searchRow{margin-top:10px;}
#search{
  width:100%;padding:10px;border-radius:8px;
  background:#111;border:1px solid #444;color:white;box-sizing:border-box;
}
#buttonRow{
  margin-top:6px;display:flex;gap:6px;flex-wrap:wrap
}
#buttonRow button{
  flex:1;padding:6px 4px;font-size:10px;color:#bbb;
  border-radius:8px;background:#000;border:1px solid #444;
  font-weight:bold;height:35px;
}

/* Tabelle Container */
#tableContainer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  overflow-y:scroll;
  overflow-x:auto; /* Wichtig f√ºr breite Tabellen */
  background:#000;
  z-index:100;
  padding-bottom:calc(env(safe-area-inset-bottom) + 16px);
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout: fixed; /* Besser f√ºr Breiten-Steuerung */
  min-width: 700px; /* Mindestbreite f√ºr alle Spalten */
}

/* Fixed header container */
#fixedHeader {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 9999;
  background: #0f0f0f;
  overflow: hidden;
  display: none; /* Am Anfang versteckt */
}
#fixedHeader table {
  border-collapse: collapse;
  width: 100%;
  min-width: 700px;
}
#fixedHeader th {
  background: #0f0f0f;
}


th{
  /* position:sticky; top:0; z-index:200; */ /* Nicht mehr n√∂tig dank #fixedHeader */
  padding:8px 4px;
  color:#fff;
  font-size:11px;
  white-space:nowrap;
  font-weight:600;
  background:#111;
}
td{
  padding:5px 4px;
  font-size:11px;
  border-bottom:1px solid #222;
  white-space:nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Spezielle Zellen-Styles */
td.article-cell{
  vertical-align: middle;
  line-height: 1.3;
  white-space: normal;
  word-break: break-word;
}
.iconCell span{
  cursor:pointer;
  margin-right:4px;
  display: inline-block;
}
.iconCell span.delete{margin-left:4px;}

input.miniQty{
  width:40px;
  background:#111;
  color:white;
  border:1px solid #444;
  border-radius:5px;
  text-align:center;
  padding: 2px 0;
  font-size: 10px;
}

/* Farben & Zust√§nde */
.tr-zero-stock{ background:#3a0000 !important; }
.selectedRow{ background:#0b2a4a !important; }
.marked{ background:#222; }


/* ================================================= */
/* Popup-Styles (Kompakt) */
/* ================================================= */

#popup, #viewPopup, #salePopup, #salesHistoryPopup{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#111;padding:16px;
  border:2px solid #444;border-radius:12px;
  width:400px;max-width:92vw;
  max-height: 90vh;
  overflow-y: auto;
  display:none;z-index:9999;
}
.popup-row{margin-bottom:8px;text-align:left;}
.popup-row label{font-size:12px;color:#bbb;display:block;margin-bottom:3px;text-align:left;}
.popup-row input,.popup-row textarea,.popup-row select{
  box-sizing:border-box;
  width:100%;padding:8px;border-radius:8px;
  border:1px solid #444;background:#1a1a1a;color:white;
}
#popupButtons, #saleButtons{display:flex;gap:8px;margin-top:10px;}
#popupButtons button, #saleButtons button{
  flex:1;padding:7px;border-radius:8px;background:#000;
  border:1px solid #444;color:#fff;font-weight:bold;font-size:11px;height:34px;
}
#salesHistoryPopup table{
  width:100%;border-collapse:collapse;font-size:10px;
  min-width: 600px;
}
#salesHistoryPopup th, #salesHistoryPopup td{
  border:1px solid #444;padding:4px;white-space:nowrap;
}
</style>

</head>
<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box"><div class="counter-title">Artikel</div><div id="countArtikel" class="counter-value">0</div></div>
    <div class="counter-box"><div class="counter-title">Menge</div><div id="countMenge" class="counter-value">0</div></div>
    <div class="counter-box"><div class="counter-title">Aktueller Wert (‚Ç¨)</div><div id="countWert" class="counter-value">0</div></div>
    <div class="counter-box"><div class="counter-title">Gesamtwert (‚Ç¨)</div><div id="countWertTotal" class="counter-value">0</div></div>
    <div class="counter-box"><div class="counter-title">Umsatz Jahr (‚Ç¨)</div><div id="countUmsatzJahr" class="counter-value">0</div></div>
    <div class="counter-box"><div class="counter-title">Gewinn Gesamt (‚Ç¨)</div><div id="countGewinn" class="counter-value">0</div></div>
  </div>

  <div id="searchRow"><input id="search" placeholder="Suchen..."></div>

  <div id="buttonRow">
    <button id="btnAdd">Artikel ‚ûï</button>
    <button id="btnSales">Verk√§ufe üõí</button>
    <button id="btnExport">Sichern ‚¨áÔ∏è</button>
    <button id="btnImport">Laden ‚¨ÜÔ∏è</button>
    <button id="btnPDF">PDF üìÑ</button>
  </div>
</div>

<div id="tableContainer">
<table>
  <thead>
    <tr class="table-header">
      <th style="width:30px;">‚òÖ</th>
      <th style="width:70px;">Nr</th>
      <th style="width:180px;">Name</th>
      <th style="width:60px;">Zustand</th>
      <th style="width:70px;">Menge</th>
      <th style="width:70px;">Gr√∂√üe</th>
      <th style="width:70px;">EK</th>
      <th style="width:100px;">Gesamt</th>
      <th style="width:70px;">Ort</th>
      <th style="width:80px;">Datum</th>
      <th style="width:100px;">Aktion</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    </tbody>
</table>
</div>

<div id="popup">
  <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
  <div class="popup-row"><label>Name</label><input id="p_name"></div>
  <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1"></div>
  <div class="popup-row"><label>Gr√∂√üe</label><input id="p_groesse"></div>
  <div class="popup-row"><label>Preis (Einkauf, pro St√ºck)</label><input type="number" id="p_preis" step="0.01"></div>
  <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
  <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
  <div class="popup-row">
    <label>Zustand</label>
    <select id="p_zustand">
      <option value="Neu">Neu</option>
      <option value="Gebraucht">Gebraucht</option>
    </select>
  </div>
  <div class="popup-row"><label>Bild</label><input type="file" id="p_bild" accept="image/*" capture="environment"></div>
  <div class="popup-row"><label>Notiz</label><textarea id="p_notiz"></textarea></div>
  <div id="popupButtons">
    <button id="btnSave">Speichern</button>
    <button id="btnCancel">Abbrechen</button>
  </div>
</div>

<div id="viewPopup"></div>

<div id="salePopup">
  <div class="popup-row"><label>Rechnungsnummer</label><input id="s_rechnung"></div>
  <div class="popup-row"><label>Verkaufte Menge</label><input type="number" id="s_menge" min="1"></div>
  <div class="popup-row"><label>Verkaufspreis pro St√ºck (‚Ç¨)</label><input type="number" id="s_preis" step="0.01"></div>
  <div class="popup-row"><label>Versand vom Kunden (‚Ç¨)</label><input type="number" id="s_versandKunde" step="0.01"></div>
  <div class="popup-row"><label>Eigene Versandkosten (‚Ç¨)</label><input type="number" id="s_versandKosten" step="0.01"></div>
  <div class="popup-row"><label>Verkaufsdatum</label><input type="date" id="s_datum"></div>
  <div id="saleButtons">
    <button id="btnSaleOk">Verkaufen</button>
    <button id="btnSaleCancel">Abbrechen</button>
  </div>
</div>

<div id="salesHistoryPopup">
  <h3>Verk√§ufe</h3>
  <input id="salesSearch" placeholder="Suche..." style="width:100%;margin-bottom:8px;">
  <table>
    <thead>
      <tr>
        <th>Rechnung</th>
        <th>Datum</th>
        <th>ArtNr</th>
        <th>Name</th>
        <th>Menge</th>
        <th>Umsatz (‚Ç¨)</th>
        <th>Gewinn (‚Ç¨)</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="salesBody"></tbody>
  </table>
  <div style="margin-top:10px;text-align:right;">
    <button onclick="closeSalesHistory()">Schlie√üen</button>
  </div>
</div>

<script>
// =================================================
// GLOBALE VARIABLEN & DATENSPEICHERUNG
// =================================================

let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");
let sales   = JSON.parse(localStorage.getItem("lagerSales") || "[]");

let editIndex = -1;
let currentSaleIndex = -1;
let selectedRowIndex = -1;
let editSaleIndex = -1;

const popup     = document.getElementById("popup");
const viewPopup = document.getElementById("viewPopup");
const salePopup = document.getElementById("salePopup");
const salesHistoryPopup = document.getElementById("salesHistoryPopup");
const tableBody = document.getElementById("tableBody");
const searchInp = document.getElementById("search");
const salesSearchInput = document.getElementById("salesSearch");


/* ----- HILFSFUNKTIONEN ----- */

/** Setzt den File-Input zur√ºck. */
function resetFileInput(input){
  const newInput = input.cloneNode();
  input.parentNode.replaceChild(newInput, input);
  return newInput;
}

/** Formatiert ein Datum von YYYY-MM-DD zu DD-MM-YYYY. */
function formatDate(d){
  if(!d) return "";
  const [y,m,dd] = d.split("-");
  return `${dd}-${m}-${y}`;
}

/** Passt die Startposition der Tabelle dynamisch an die H√∂he des Headers an. */
function adjustTableTop(){
  const header = document.getElementById("topbar");
  const tableC = document.getElementById("tableContainer");
  tableC.style.top = header.offsetHeight + "px";
}

/** F√ºhrt ein Backup der Daten in eine JSON-Datei durch. */
function autoBackup(reason){
  const data = { artikel, sales };
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const a    = document.createElement("a");
  a.href     = URL.createObjectURL(blob);
  a.download = `lager_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

/** Generiert die n√§chste fortlaufende Rechnungsnummer (001-YYYY) */
function getNextSaleNumber(){
  const currentYear = new Date().getFullYear();
  const key  = "saleCounter_" + currentYear;
  let counter = Number(localStorage.getItem(key) || 0);

  // Finde die h√∂chste Rechnungsnummer aus dem aktuellen Jahr in den Sales, um Redundanz zu vermeiden
  sales.forEach(s => {
    const match = (s.rechnungsnr || "").match(/^(\d+)-(\d{4})$/);
    if(match && Number(match[2]) === currentYear){
      counter = Math.max(counter, Number(match[1]));
    }
  });

  counter++;
  localStorage.setItem(key, counter);
  return String(counter).padStart(3,"0") + "-" + currentYear;
}


/* ----- ARTIKELNUMMERN LOGIK ----- */
// Die Original Logik wird beibehalten

function initArtNrCounter(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  if (localStorage.getItem(key) !== null) return;
  let max = -1;
  artikel.forEach(a=>{
    if(!a.artnr) return;
    const m = a.artnr.match(/^(\d{3})-(\d{4})$/);
    if(m && Number(m[2]) === jahr){
      max = Math.max(max, Number(m[1]));
    }
  });
  localStorage.setItem(key, max);
}

function previewNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  const val  = Number(localStorage.getItem(key) || -1) + 1;
  return String(val).padStart(3,"0") + "-" + jahr;
}

function commitNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  let counter = Number(localStorage.getItem(key) || -1) + 1;
  localStorage.setItem(key, counter);
  return String(counter).padStart(3,"0") + "-" + jahr;
}
initArtNrCounter();


/* =================================================
// HAUPT-RENDER-FUNKTIONEN
// ================================================= */

function renderTable(){
  tableBody.innerHTML = "";
  // Sortierung: Zuerst markiert (‚òÖ), dann Menge absteigend, dann ArtNr
  const sortedArtikel = [...artikel].sort((a,b)=>{
    if(a.markiert && !b.markiert) return -1;
    if(!a.markiert && b.markiert) return 1;
    return (b.menge || 0) - (a.menge || 0);
  });

  sortedArtikel.forEach(a=>{
    const i = artikel.indexOf(a); // Index im Original-Array beibehalten
    if(!a) return;

    const tr = document.createElement("tr");
    tr.onclick = () => selectRow(i);
    if(a.markiert) tr.classList.add("marked");
    if(i === selectedRowIndex) tr.classList.add("selectedRow");
    if(a.menge === 0) tr.classList.add("tr-zero-stock");

    const ek = (a.preis || 0);
    const gesamt = (ek * (a.menge || 0)).toFixed(2);
    const ekFormatted = ek.toFixed(2);

    tr.innerHTML = `
      <td style="width:30px;" onclick="event.stopPropagation(); toggleMark(${i})">${a.markiert ? "‚òÖ" : "‚òÜ"}</td>
      <td style="width:70px;">${a.artnr || ""}</td>
      <td style="width:180px;" class="article-cell">${a.name || ""}</td>
      <td style="width:60px;">${a.zustand || ""}</td>
      <td style="width:70px;">
        <input class="miniQty" type="number" value="${a.menge}" onclick="event.stopPropagation()" oninput="updateQty(${i},this.value)">
      </td>
      <td style="width:70px;">${a.groesse || ""}</td>
      <td style="width:70px;">${ekFormatted}</td>
      <td style="width:100px;">${gesamt}</td>
      <td style="width:70px;">${a.ort || ""}</td>
      <td style="width:80px;">${a.datum ? formatDate(a.datum) : ""}</td>
      <td style="width:100px;" class="iconCell">
        <span onclick="event.stopPropagation(); viewImg(${i})" style="${a.bild ? 'opacity:1;' : 'opacity:0.3; pointer-events:none;'}">üì∑</span>
        <span onclick="event.stopPropagation(); viewNote(${i})" style="${a.notiz ? 'opacity:1;' : 'opacity:0.3; pointer-events:none;'}">üìù</span>
        <span onclick="event.stopPropagation(); editArtikel(${i})">‚úèÔ∏è</span>
        <span onclick="event.stopPropagation(); sellArtikel(${i})">üõí</span>
        <span class="delete" onclick="event.stopPropagation(); del(${i})">üóë</span>
      </td>
    `;
    tableBody.appendChild(tr);
  });

  updateCounters();
  adjustTableTop();
}

function updateCounters(){
  let mengeTotal = 0;
  let warenwertAktuell = 0;
  let warenwertGesamt = 0; // Hier EK * Gesamtmenge (inkl. verkaufter?) - Logik beibehalten

  artikel.forEach(a=>{
    mengeTotal += a.menge || 0;
    warenwertAktuell += (a.menge || 0) * (a.preis || 0);
    warenwertGesamt += (a.menge || 0) * (a.preis || 0);
  });
  document.getElementById("countArtikel").textContent   = artikel.filter(a=>a && a.menge>0).length;
  document.getElementById("countMenge").textContent     = mengeTotal;
  document.getElementById("countWert").textContent      = warenwertAktuell.toFixed(2);
  document.getElementById("countWertTotal").textContent = warenwertGesamt.toFixed(2);

  let umsatzGes = 0;
  let gewinnGes = 0;
  let umsatzJahr = 0;
  const currentYear = new Date().getFullYear();

  sales.forEach(s=>{
    const u = s.umsatz || 0;
    const g = s.gewinn || 0;
    umsatzGes += u;
    gewinnGes += g;
    if(s.datum){
      const year = parseInt(s.datum.slice(0,4),10);
      if(year === currentYear) umsatzJahr += u;
    }
  });

  const umsatzElm = document.getElementById("countUmsatzJahr");
  const gewinnElm = document.getElementById("countGewinn");

  umsatzElm.textContent = umsatzJahr.toFixed(2);
  gewinnElm.textContent = gewinnGes.toFixed(2);

  // Warnfarben f√ºr 25.000-Grenze
  umsatzElm.style.color = "#bbb";
  if(umsatzJahr >= 25000){
    umsatzElm.style.color = "#ff4d4d"; // rot
  }else if(umsatzJahr >= 22000){
    umsatzElm.style.color = "#ffae42"; // orange
  }
}

/* =================================================
// AKTIONEN IN DER TABELLE
// ================================================= */

function toggleMark(i){
  autoBackup("markierung");
  artikel[i].markiert = !artikel[i].markiert;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  renderTable();
}

function updateQty(i,val){
  artikel[i].menge = parseInt(val) || 0;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  updateCounters();
}

function selectRow(i){
  selectedRowIndex = selectedRowIndex === i ? -1 : i;
  renderTable();
}

function del(i){
  if(confirm("Wirklich l√∂schen?")){
    autoBackup("l√∂schen");
    artikel.splice(i,1);
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    renderTable();
  }
}

function viewImg(i){
  const a = artikel[i];
  viewPopup.innerHTML = a.bild
    ? `<img style="max-width:90vw; max-height:80vh;" src="${a.bild}"><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`
    : `<div>Kein Bild</div><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}

function viewNote(i){
  const a = artikel[i];
  viewPopup.innerHTML = `<div>${a.notiz || "Keine Notiz"}</div>
  <br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}


/* =================================================
// ARTIKEL-POPUP LOGIK (Neu/Bearbeiten)
// ================================================= */

const p_artnr   = document.getElementById("p_artnr");
const p_name    = document.getElementById("p_name");
const p_menge   = document.getElementById("p_menge");
const p_groesse = document.getElementById("p_groesse");
const p_preis   = document.getElementById("p_preis");
const p_ort     = document.getElementById("p_ort");
const p_datum   = document.getElementById("p_datum");
const p_zustand = document.getElementById("p_zustand");
let p_bild      = document.getElementById("p_bild");
const p_notiz   = document.getElementById("p_notiz");
const btnAdd    = document.getElementById("btnAdd");
const btnSave   = document.getElementById("btnSave");
const btnCancel = document.getElementById("btnCancel");


btnAdd.onclick = () => {
  editIndex = -1;
  p_artnr.value       = previewNextArtNr();
  p_name.value        = "";
  p_menge.value       = 1;
  p_groesse.value     = "";
  p_preis.value       = "";
  p_ort.value         = "";
  p_datum.value       = "";
  p_zustand.value     = "Neu";
  p_bild = resetFileInput(p_bild);
  p_notiz.value       = "";
  popup.style.display = "block";
};

btnCancel.onclick = () => {
  popup.style.display = "none";
  editIndex = -1;
};

btnSave.onclick = () => {
  const isNew = editIndex === -1;
  const artnrInput = p_artnr.value.trim();
  const nextNr = isNew ? commitNextArtNr() : artikel[editIndex].artnr;
  const artnrFinal = artnrInput || nextNr;

  const obj = {
    artnr:  artnrFinal,
    name:   p_name.value.trim(),
    menge: +p_menge.value || 0,
    groesse:p_groesse.value.trim(),
    preis: +p_preis.value || 0,
    ort:    p_ort.value.trim(),
    datum:  p_datum.value,
    zustand:p_zustand.value || "Neu",
    notiz:  p_notiz.value.trim(),
    bild:   isNew ? "" : artikel[editIndex]?.bild || "",
    markiert: isNew ? false : artikel[editIndex]?.markiert || false
  };

  const file = p_bild.files[0];
  if(file){
    const r = new FileReader();
    r.onload = e => { obj.bild = e.target.result; finishSave(isNew, obj); };
    r.readAsDataURL(file);
  } else {
    finishSave(isNew, obj);
  }
};

function finishSave(isNew, obj){
  if(isNew){
    artikel.push(obj);
  } else {
    artikel[editIndex] = obj;
  }
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  popup.style.display = "none";
  editIndex = -1;
  renderTable();
}

function editArtikel(i){
  editIndex       = i;
  const a         = artikel[i];
  p_artnr.value   = a.artnr || "";
  p_name.value    = a.name || "";
  p_menge.value   = a.menge || 1;
  p_groesse.value = a.groesse || "";
  p_preis.value   = a.preis || 0;
  p_ort.value     = a.ort || "";
  p_datum.value   = a.datum || "";
  p_zustand.value = a.zustand || "Neu";
  p_bild = resetFileInput(p_bild);
  p_notiz.value   = a.notiz || "";
  popup.style.display = "block";
}


/* =================================================
// VERKAUF-LOGIK
// ================================================= */

const btnSales       = document.getElementById("btnSales");
const btnSaleOk      = document.getElementById("btnSaleOk");
const btnSaleCancel  = document.getElementById("btnSaleCancel");
const s_menge        = document.getElementById("s_menge");
const s_preis        = document.getElementById("s_preis");
const s_versandKunde = document.getElementById("s_versandKunde");
const s_versandKosten= document.getElementById("s_versandKosten");
const s_datum        = document.getElementById("s_datum");
const s_rechnung     = document.getElementById("s_rechnung");

btnSales.onclick = () => openSalesHistory();

function sellArtikel(i){
  currentSaleIndex = i;
  editSaleIndex    = -1;
  const a = artikel[i];

  s_menge.value        = a.menge || 1;
  s_menge.max          = a.menge;
  s_menge.disabled     = false;
  s_preis.value        = "";
  s_versandKunde.value = "";
  s_versandKosten.value= "";
  s_datum.value        = new Date().toISOString().slice(0,10);
  s_rechnung.value     = getNextSaleNumber();

  salePopup.style.display = "block";
}

btnSaleCancel.onclick = () => {
  salePopup.style.display = "none";
  currentSaleIndex = -1;
  editSaleIndex = -1;
};

btnSaleOk.onclick = () => {
  const mengeV = parseInt(s_menge.value) || 0;
  const preisV = parseFloat(s_preis.value) || 0;
  const versK  = parseFloat(s_versandKunde.value) || 0;
  const versC  = parseFloat(s_versandKosten.value) || 0;
  const datV   = s_datum.value;
  const rNr    = s_rechnung.value || "";

  if(mengeV <= 0){
    alert("Verkaufte Menge muss gr√∂√üer als 0 sein.");
    return;
  }
  
  if(rNr === ""){
    alert("Rechnungsnummer fehlt!");
    return;
  }

  // Fall: Bearbeiten eines bestehenden Verkaufs (nur Werte √§ndern)
  if(editSaleIndex >= 0){
    const s = sales[editSaleIndex];
    if(!s) return;
    s.verkaufPreis = preisV;
    s.versandKunde = versK;
    s.versandKosten= versC;
    s.datum        = datV;
    s.rechnungsnr  = rNr;

    const umsatzNeu = s.menge * s.verkaufPreis + s.versandKunde;
    const einkaufNeu= s.menge * (s.einkaufPreis || 0);
    s.umsatz = umsatzNeu;
    s.gewinn = umsatzNeu - einkaufNeu - s.versandKosten;

    localStorage.setItem("lagerSales", JSON.stringify(sales));
    salePopup.style.display = "none";
    editSaleIndex = -1;
    openSalesHistory();
    updateCounters();
    return;
  }

  // Fall: Neuer Verkauf (Bestand reduzieren)
  if(currentSaleIndex === -1) return;
  const a = artikel[currentSaleIndex];

  if(mengeV > a.menge){
    alert("Verkaufte Menge √ºbersteigt den Bestand.");
    return;
  }

  autoBackup("verkauf");

  const umsatz = mengeV * preisV + versK;
  const einkaufKosten = mengeV * (a.preis || 0);
  const gewinn = umsatz - einkaufKosten - versC;

  const sale = {
    artnr: a.artnr,
    name:  a.name,
    menge: mengeV,
    verkaufPreis: preisV,
    versandKunde: versK,
    versandKosten: versC,
    einkaufPreis: a.preis || 0,
    datum: datV,
    umsatz,
    gewinn,
    rechnungsnr: rNr
  };

  sales.push(sale);
  localStorage.setItem("lagerSales", JSON.stringify(sales));

  a.menge -= mengeV;
  localStorage.setItem("lagerData", JSON.stringify(artikel));

  salePopup.style.display = "none";
  currentSaleIndex = -1;
  renderTable();
  updateCounters();
};


/* =================================================
// VERKAUFSHISTORIE
// ================================================= */

salesSearchInput.oninput = () => renderSalesList(salesSearchInput.value);

function openSalesHistory(){
  renderSalesList(salesSearchInput.value);
  salesHistoryPopup.style.display = "block";
}

function renderSalesList(filter){
  const tbody = document.getElementById("salesBody");
  if(!tbody) return;
  tbody.innerHTML = "";
  const q = (filter || "").toLowerCase();

  sales.forEach((s,idx)=>{
    const txt = (s.name||"") + " " + (s.artnr||"") + " " + (s.rechnungsnr||"") + " " + (s.datum||"");
    if(q && !txt.toLowerCase().includes(q)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.rechnungsnr || ""}</td>
      <td>${s.datum ? formatDate(s.datum) : ""}</td>
      <td>${s.artnr || ""}</td>
      <td>${s.name || ""}</td>
      <td>${s.menge || 0}</td>
      <td>${(s.umsatz||0).toFixed(2)}</td>
      <td>${(s.gewinn||0).toFixed(2)}</td>
      <td>
        <button style="height:25px;" onclick="editSale(${idx})">‚úèÔ∏è</button>
        <button style="height:25px;" onclick="stornoSale(${idx})">‚§¥Ô∏è</button>
        <button style="height:25px;" onclick="deleteSale(${idx})">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function closeSalesHistory(){
  salesHistoryPopup.style.display = "none";
}

function stornoSale(index){
  const s = sales[index];
  if(!s) return;
  if(!confirm(`Verkauf '${s.rechnungsnr}' stornieren? Bestand wird um ${s.menge} erh√∂ht.`)) return;

  autoBackup("storno");

  const art = artikel.find(a => a.artnr === s.artnr);
  if(art){
    art.menge = (art.menge || 0) + (s.menge || 0);
  }else{
    artikel.push({
      artnr: s.artnr,
      name: s.name,
      menge: s.menge || 0,
      groesse:"", preis: s.einkaufPreis || 0,
      ort:"", datum:s.datum || "", zustand:"Neu",
      notiz:"Storno automatisch angelegt", bild:"", markiert:false
    });
  }

  sales.splice(index,1);
  localStorage.setItem("lagerSales", JSON.stringify(sales));
  localStorage.setItem("lagerData", JSON.stringify(artikel));

  openSalesHistory();
  renderTable();
}

function editSale(index){
  const s = sales[index];
  if(!s) return;

  editSaleIndex    = index;
  currentSaleIndex = -1;

  s_menge.value        = s.menge || 1;
  s_menge.disabled     = true; // Menge beim Editieren sperren (nur √ºber Storno √§nderbar)

  s_preis.value        = s.verkaufPreis || 0;
  s_versandKunde.value = s.versandKunde || 0;
  s_versandKosten.value= s.versandKosten || 0;
  s_datum.value        = s.datum || new Date().toISOString().slice(0,10);
  s_rechnung.value     = s.rechnungsnr || "";

  salePopup.style.display = "block";
}

function deleteSale(index){
  const s = sales[index];
  if(!s) return;
  if(!confirm(`Verkauf '${s.rechnungsnr}' endg√ºltig aus der Liste l√∂schen (KEIN BESTANDSAUSGLEICH!)?`)) return;

  sales.splice(index,1);
  localStorage.setItem("lagerSales", JSON.stringify(sales));
  openSalesHistory();
  updateCounters();
}


/* =================================================
// SICHERN / LADEN / PDF
// ================================================= */

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const btnPDF    = document.getElementById("btnPDF");

btnExport.onclick = () => { autoBackup("manuell"); };

btnImport.onclick = () => {
  const inp = document.createElement("input");
  inp.type  = "file";
  inp.accept= "application/json";

  inp.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;

    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        
        if(data.artikel && Array.isArray(data.artikel)){
          artikel = data.artikel;
          sales   = data.sales || [];
        } else if(Array.isArray(data)){
          artikel = data;
          sales   = [];
        } else{
          alert("Unbekanntes Dateiformat!");
          return;
        }

        localStorage.setItem("lagerData", JSON.stringify(artikel));
        localStorage.setItem("lagerSales", JSON.stringify(sales));

        initArtNrCounter();
        renderTable();
        alert("Daten erfolgreich geladen ‚úî");

      }catch(err){
        console.error(err);
        alert("Datei konnte nicht gelesen werden!");
      }
    };
    r.readAsText(file);
  };
  inp.click();
};

btnPDF.onclick = () => {
  let w = window.open("","_blank");
  let html = `<h1>Lagerbestand</h1>
  <table border="1" cellpadding="4" style="width:100%; font-family:Arial, sans-serif; font-size:12px;">
  <tr><th>Nr</th><th>Name</th><th>Menge</th><th>EK (‚Ç¨)</th><th>Gesamt (‚Ç¨)</th><th>Ort</th><th>Datum</th></tr>`;
  artikel.forEach(a=>{
    if(!a || a.menge <= 0) return;
    const ek = (a.preis || 0).toFixed(2);
    const gesamt = ((a.preis || 0) * (a.menge || 0)).toFixed(2);
    html += `<tr><td>${a.artnr||""}</td><td>${a.name||""}</td><td>${a.menge||0}</td><td>${ek}</td><td>${gesamt}</td><td>${a.ort||""}</td><td>${a.datum ? formatDate(a.datum) : ""}</td></tr>`;
  });
  html += `</table>`;
  w.document.write(html);
  w.document.close();
  w.print();
};

/* =================================================
// SUCHE
// ================================================= */

searchInp.oninput = () => {
  const q = searchInp.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
};


/* =================================================
// INITIALISIERUNG & FIXED HEADER LOGIK
// ================================================= */

document.addEventListener("DOMContentLoaded", () => {
  renderTable();

  // --- Fixed Header Logik ---
  const table = document.querySelector("table");
  const thead = table.querySelector("thead");
  const container = document.getElementById("tableContainer");
  if(thead && container){
    const fixed = document.createElement("div");
    fixed.id = "fixedHeader";
    const cloneTable = document.createElement("table");
    cloneTable.appendChild(thead.cloneNode(true));
    fixed.appendChild(cloneTable);
    document.body.appendChild(fixed);

    function syncWidths(){
      const origThs = thead.querySelectorAll("th");
      const cloneThs = fixed.querySelectorAll("th");
      
      // Breite der Fixed-Table anpassen, damit der Scroll-Wert √ºbereinstimmt
      cloneTable.style.width = table.offsetWidth + "px"; 

      origThs.forEach((th,i)=>{
        // Spaltenbreiten synchronisieren
        if(cloneThs[i]) cloneThs[i].style.width = th.offsetWidth + "px";
      });

      // Fixed Header nur anzeigen, wenn gescrollt wird
      fixed.style.display = container.scrollTop > 0 ? "block" : "none";
      
      // Horizontalen Scroll synchronisieren
      fixed.scrollLeft = container.scrollLeft;
      
      // Position des Fixed Header anpassen (unter der Topbar)
      const topbarHeight = document.getElementById("topbar").offsetHeight;
      fixed.style.top = topbarHeight + "px";
    }

    container.addEventListener("scroll", syncWidths);
    window.addEventListener("resize", syncWidths);
    window.addEventListener("orientationchange", syncWidths);
    
    // Initialisierung nach Render
    setTimeout(syncWidths, 100); 
  }
});
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('Service Worker registriert: ', reg.scope))
      .catch(err => console.log('Service Worker Registrierung fehlgeschlagen: ', err));
  });
}
</script>
</body>
</html>
