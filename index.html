<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lager V21 Final Fix</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --input-bg: #2d2d2d;
            --primary: #3b82f6; --text: #e5e7eb; --text-muted: #9ca3af;
            --border: #333; --danger: #ef4444; --success: #10b981; --profit: #eab308;
            color-scheme: dark; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }

        /* FIXED HEADER FIX */
        .app-header { background: rgba(30,30,30,0.98); backdrop-filter: blur(10px); padding: 8px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        h1 { margin: 0; font-size: 1rem; font-weight: 800; color: white; }
        
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { 
            background: #252525; border: 1px solid #444; color: white; 
            width: 42px; height: 42px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; cursor: pointer; position: relative; z-index: 1001;
        }

        .search-container { position: relative; width: 100%; margin-top: 5px; }
        .search-input { width: 100%; height: 36px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; padding: 0 35px; color: white; font-size: 0.9rem; box-sizing: border-box; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* STATS */
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; margin-top: 10px; padding-top: 8px; border-top: 1px solid #333; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.6rem; color: #777; display: block; }
        .stat-val { font-size: 0.75rem; font-weight: bold; display: block; }
        .c-blue { color: #60a5fa; } .c-green { color: var(--success); } .c-gold { color: var(--profit); }

        /* LISTE */
        .item-row { background: var(--card); border-bottom: 1px solid #252525; padding: 8px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
        .qty-badge { background: #252525; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-weight: bold; color: var(--primary); font-size: 0.8rem; }
        .item-title { font-size: 0.75rem; font-weight: 600; display: block; margin-bottom: 2px; }
        .item-meta { font-size: 0.65rem; color: #777; }
        .btn-mini { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer; }

        /* GROUPED HISTORY */
        .sale-group { background: #1a1a1a; margin: 10px; border: 1px solid #333; border-radius: 8px; }
        .group-header { background: #222; padding: 8px; display: flex; justify-content: space-between; border-bottom: 1px solid #333; font-size: 0.7rem; }
        .group-item { padding: 8px; border-bottom: 1px solid #252525; display: flex; justify-content: space-between; align-items: center; }
        .group-footer { padding: 8px; display: flex; justify-content: space-between; align-items: center; background: #151515; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card); width: 95%; max-width: 500px; border-radius: 12px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { padding: 12px; font-weight: bold; border-bottom: 1px solid #333; text-align: center; }
        .modal-body { padding: 15px; }
        .modal-footer { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #151515; }

        .basket-item { background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        #addItemSearch { width: 100%; padding: 10px; background: #111; border: 1px dashed #444; color: #888; border-radius: 8px; margin: 10px 0; }
        
        input, select, textarea { width: 100%; height: 40px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; padding: 0 10px; box-sizing: border-box; margin-bottom: 10px; }
        label { font-size: 0.7rem; color: #888; margin-bottom: 4px; display: block; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--primary); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 500; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-top">
            <h1>üì¶ MEIN LAGER</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="openHistory()" title="Verlauf">üïí</button>
                <button class="icon-btn" onclick="openSettings()" title="Einstellungen">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Artikel suchen..." onkeyup="filterList()">
        </div>
        <div class="stats-bar">
            <div class="stat-box"><span class="stat-label">Menge</span><span id="statCount" class="stat-val">0</span></div>
            <div class="stat-box"><span class="stat-label">Wert</span><span id="statValue" class="stat-val c-blue">0 ‚Ç¨</span></div>
            <div class="stat-box"><span class="stat-label">Umsatz</span><span id="statRevenue" class="stat-val c-green">0 ‚Ç¨</span></div>
            <div class="stat-box"><span class="stat-label">Gewinn</span><span id="statProfit" class="stat-val c-gold">0 ‚Ç¨</span></div>
        </div>
    </div>

    <div id="itemList"></div>
    <button class="fab" onclick="openEditModal()">+</button>

    <div id="modalSettings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Einstellungen / Backup</div>
            <div class="modal-body">
                <button class="btn-full btn-blue" onclick="exportBackup()" style="margin-bottom:20px;">Backup Datei erstellen</button>
                <label>Backup einspielen (JSON Datei)</label>
                <input type="file" accept=".json" onchange="importBackup(this)">
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()" style="grid-column: 1/-1">Schlie√üen</button>
            </div>
        </div>
    </div>

    <div id="modalSell" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Verkauf</div>
            <div class="modal-body">
                <label>Rechnungsnummer</label>
                <input type="text" id="sellInvoiceNr">
                <div id="sellBasketList"></div>
                <input type="text" id="addItemSearch" placeholder="+ Weiteren Artikel hinzuf√ºgen..." onkeyup="searchForItem(this)">
                <div id="searchDropdown" style="display:none; background:#333; border-radius:8px; margin-bottom:10px;"></div>
                <label>Versandkosten (‚Ç¨)</label>
                <input type="number" id="sellShipping" value="0" oninput="calcBasketTotal()">
                <label>Gesamtpreis</label>
                <input type="text" id="sellTotal" disabled style="color:var(--success); font-weight:bold;">
                <label>Rechnungsbild</label>
                <input type="file" onchange="handleImage(this, 'sellBild', 'sellImgPreview')">
                <input type="hidden" id="sellBild">
                <img id="sellImgPreview" style="width:100%; display:none; border-radius:8px; margin-top:10px;">
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()">Abbrechen</button>
                <button class="btn-full btn-blue" onclick="performSell()">Verkauf abschlie√üen</button>
            </div>
        </div>
    </div>

    <div id="modalHistory" class="modal-overlay">
        <div class="modal-box" style="width:100%; max-width:600px;">
            <div class="modal-header">Verlauf</div>
            <div id="historyList" style="padding:10px;"></div>
            <div class="modal-footer"><button class="btn-full btn-gray" onclick="closeModals()" style="grid-column:1/-1">Schlie√üen</button></div>
        </div>
    </div>

    <div id="modalEdit" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Artikel bearbeiten</div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <label>Name</label><input type="text" id="inpName">
                <label>Menge</label><input type="number" id="inpMenge">
                <label>EK-Preis (‚Ç¨)</label><input type="number" step="0.01" id="inpPreis">
                <label>Art.-Nr.</label><input type="text" id="inpArtnr">
                <label>Bild</label>
                <input type="file" onchange="handleImage(this, 'inpBild', 'imgPreviewEdit')">
                <input type="hidden" id="inpBild">
                <img id="imgPreviewEdit" style="width:100%; display:none; border-radius:8px; margin-top:10px;">
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()">Abbrechen</button>
                <button class="btn-full btn-blue" onclick="saveItem()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'LagerDB_V1';
        let db, inventory = [], salesLog = [];

        async function init() {
            db = await new Promise(r => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => {
                    const d = e.target.result;
                    d.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                    d.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                };
                req.onsuccess = e => r(e.target.result);
            });
            await loadData();
            renderList();
        }

        async function loadData() {
            inventory = await dbOp('inventory', 'getAll');
            salesLog = await dbOp('sales', 'getAll');
        }

        function dbOp(store, method, data) {
            return new Promise(r => {
                const tx = db.transaction(store, 'readwrite');
                const s = tx.objectStore(store);
                const req = data ? s[method](data) : s[method]();
                req.onsuccess = () => r(req.result);
            });
        }

        function renderList() {
            const list = document.getElementById('itemList');
            list.innerHTML = '';
            let tQty=0, tVal=0, tRev=0, tProf=0;

            [...inventory].reverse().forEach(i => {
                tQty += i.menge; tVal += (i.preis * i.menge);
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div class="qty-badge">${i.menge}x</div>
                    <div class="item-main">
                        <span class="item-title">${i.name}</span>
                        <span class="item-meta">#${i.artnr} | ${i.preis.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div class="item-right">
                        <button class="btn-mini" onclick="openSellModal(${i.id})">Verkauf</button>
                        <button style="background:none; border:none; color:#555; margin-top:5px;" onclick="openEditModal(${i.id})">‚úèÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });

            salesLog.forEach(s => {
                tRev += s.total;
                tProf += (s.total - (s.shipping || 0) - (s.buyPrice * s.qty));
            });

            document.getElementById('statCount').innerText = tQty;
            document.getElementById('statValue').innerText = tVal.toFixed(2) + "‚Ç¨";
            document.getElementById('statRevenue').innerText = tRev.toFixed(2) + "‚Ç¨";
            document.getElementById('statProfit').innerText = tProf.toFixed(2) + "‚Ç¨";
        }

        // --- VERLAUF GRUPPIERT ---
        function openHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            document.getElementById('modalHistory').style.display = 'flex';
            const groups = {};
            salesLog.forEach(s => {
                if(!groups[s.invoiceNr]) groups[s.invoiceNr] = { items:[], total:0, date:s.date, img:s.invoiceImg };
                groups[s.invoiceNr].items.push(s);
                groups[s.invoiceNr].total += s.total;
            });
            Object.keys(groups).reverse().forEach(inv => {
                const g = groups[inv];
                const div = document.createElement('div');
                div.className = 'sale-group';
                let itemsHtml = g.items.map(it => `
                    <div class="group-item">
                        <span style="font-size:0.7rem;">${it.name} (${it.qty}x)</span>
                        <button class="btn-icon-sm btn-storno" onclick="restoreSale(${it.id})">‚Ü©Ô∏è</button>
                    </div>
                `).join('');
                div.innerHTML = `
                    <div class="group-header"><span>Rechnung: ${inv}</span><span>${g.date}</span></div>
                    ${itemsHtml}
                    <div class="group-footer">
                        <span class="c-green" style="font-size:0.8rem; font-weight:bold;">Gesamt: ${g.total.toFixed(2)}‚Ç¨</span>
                        <div style="display:flex; gap:5px;">
                            ${g.img ? `<button class="btn-icon-sm" onclick="viewImg('${g.img}')">üëÅÔ∏è</button>` : ''}
                            <button class="btn-icon-sm" onclick="deleteInv('${inv}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- VERKAUF MULTI ---
        let currentBasket = [];
        function openSellModal(id) {
            const it = inventory.find(x => x.id === id);
            currentBasket = [{ id: it.id, name: it.name, artnr: it.artnr, stock: it.menge, qty: 1, priceTotal: it.preis, buyPrice: it.preis }];
            document.getElementById('sellInvoiceNr').value = "RE-" + Date.now().toString().slice(-6);
            document.getElementById('sellDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('sellShipping').value = 0;
            document.getElementById('sellBild').value = it.bild || "";
            document.getElementById('sellImgPreview').src = it.bild || "";
            document.getElementById('sellImgPreview').style.display = it.bild ? 'block' : 'none';
            renderBasket();
            document.getElementById('modalSell').style.display = 'flex';
        }

        function renderBasket() {
            const list = document.getElementById('sellBasketList');
            list.innerHTML = '';
            currentBasket.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'basket-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-size:0.7rem; font-weight:bold;">${p.name}</span>
                        <span onclick="removeFromBasket(${idx})" style="color:red; cursor:pointer;">‚úï</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="number" value="${p.qty}" onchange="updateBasket(${idx}, 'qty', this.value)">
                        <input type="number" value="${p.priceTotal}" onchange="updateBasket(${idx}, 'price', this.value)">
                    </div>
                `;
                list.appendChild(div);
            });
            calcBasketTotal();
        }

        function updateBasket(idx, key, val) {
            if(key === 'qty') currentBasket[idx].qty = parseInt(val);
            if(key === 'price') currentBasket[idx].priceTotal = parseFloat(val);
            calcBasketTotal();
        }

        function removeFromBasket(idx) {
            currentBasket.splice(idx, 1);
            renderBasket();
        }

        function calcBasketTotal() {
            let sum = currentBasket.reduce((a, b) => a + b.priceTotal, 0);
            sum += parseFloat(document.getElementById('sellShipping').value || 0);
            document.getElementById('sellTotal').value = sum.toFixed(2) + " ‚Ç¨";
        }

        function searchForItem(inp) {
            const term = inp.value.toLowerCase();
            const drop = document.getElementById('searchDropdown');
            drop.innerHTML = '';
            if(term.length < 2) { drop.style.display='none'; return; }
            inventory.filter(i => i.name.toLowerCase().includes(term) && i.menge > 0).forEach(hit => {
                const d = document.createElement('div');
                d.style.padding = '10px'; d.style.borderBottom = '1px solid #444'; d.innerText = hit.name;
                d.onclick = () => {
                    currentBasket.push({ id: hit.id, name: hit.name, artnr: hit.artnr, stock: hit.menge, qty: 1, priceTotal: hit.preis, buyPrice: hit.preis });
                    if(!document.getElementById('sellBild').value && hit.bild) {
                        document.getElementById('sellBild').value = hit.bild;
                        document.getElementById('sellImgPreview').src = hit.bild;
                        document.getElementById('sellImgPreview').style.display = 'block';
                    }
                    inp.value = ''; drop.style.display = 'none'; renderBasket();
                };
                drop.appendChild(d);
            });
            drop.style.display = 'block';
        }

        async function performSell() {
            const inv = document.getElementById('sellInvoiceNr').value;
            const ship = parseFloat(document.getElementById('sellShipping').value || 0);
            const date = document.getElementById('sellDate').value;
            const img = document.getElementById('sellBild').value;
            for(let i=0; i < currentBasket.length; i++) {
                const p = currentBasket[i];
                const it = inventory.find(x => x.id === p.id);
                it.menge -= p.qty;
                await dbOp('inventory', 'put', it);
                await dbOp('sales', 'add', {
                    name: p.name, artnr: p.artnr, date: date, buyPrice: it.preis,
                    qty: p.qty, shipping: (i===0 ? ship : 0), total: p.priceTotal + (i===0 ? ship : 0),
                    invoiceNr: inv, invoiceImg: img
                });
            }
            await loadData(); closeModals(); renderList();
        }

        async function restoreSale(id) {
            const s = salesLog.find(x => x.id === id);
            let it = inventory.find(x => x.artnr === s.artnr);
            if(it) { it.menge += s.qty; await dbOp('inventory', 'put', it); }
            else { await dbOp('inventory', 'add', { artnr:s.artnr, name:s.name, menge:s.qty, preis:s.buyPrice }); }
            await dbOp('sales', 'delete', id);
            await loadData(); openHistory(); renderList();
        }

        async function deleteInv(inv) {
            if(!confirm("Ganze Rechnung aus Liste l√∂schen?")) return;
            const toDel = salesLog.filter(s => s.invoiceNr === inv);
            for(let s of toDel) await dbOp('sales', 'delete', s.id);
            await loadData(); openHistory(); renderList();
        }

        // --- ARTIKEL EDIT ---
        function openEditModal(id) {
            const it = inventory.find(x => x.id === id);
            document.getElementById('editId').value = it.id;
            document.getElementById('inpName').value = it.name;
            document.getElementById('inpMenge').value = it.menge;
            document.getElementById('inpPreis').value = it.preis;
            document.getElementById('inpArtnr').value = it.artnr;
            document.getElementById('inpBild').value = it.bild || "";
            if(it.bild) { document.getElementById('imgPreviewEdit').src = it.bild; document.getElementById('imgPreviewEdit').style.display='block'; }
            document.getElementById('modalEdit').style.display = 'flex';
        }

        async function saveItem() {
            const id = parseInt(document.getElementById('editId').value);
            const it = inventory.find(x => x.id === id);
            it.name = document.getElementById('inpName').value;
            it.menge = parseInt(document.getElementById('inpMenge').value);
            it.preis = parseFloat(document.getElementById('inpPreis').value);
            it.artnr = document.getElementById('inpArtnr').value;
            it.bild = document.getElementById('inpBild').value;
            await dbOp('inventory', 'put', it);
            await loadData(); closeModals(); renderList();
        }

        // --- STANDARD ---
        function openSettings() { document.getElementById('modalSettings').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); document.body.style.overflow='auto'; }
        function handleImage(input, targetId, previewId) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(targetId).value = e.target.result;
                document.getElementById(previewId).src = e.target.result;
                document.getElementById(previewId).style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
        function viewImg(src) { document.getElementById('fullImage').src = src; document.getElementById('modalImageViewer').style.display = 'flex'; }
        async function exportBackup() {
            const data = { artikel: inventory, sales: salesLog };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lager_backup.json'; a.click();
        }
        function importBackup(inp) {
            const reader = new FileReader();
            reader.onload = async e => {
                const data = JSON.parse(e.target.result);
                await dbOp('inventory', 'clear'); await dbOp('sales', 'clear');
                for(let i of data.artikel) { delete i.id; await dbOp('inventory', 'add', i); }
                for(let s of data.sales) { delete s.id; await dbOp('sales', 'add', s); }
                location.reload();
            };
            reader.readAsText(inp.files[0]);
        }

        init();
    </script>
</body>
</html>
