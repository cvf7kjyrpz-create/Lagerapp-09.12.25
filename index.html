<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<title>Dein Lager-Manager (Dark Mode)</title>

<style>
/* ====================================================================
   DARK MODE FARBEN DEFINITION
   ==================================================================== */
:root {
    --bg-primary: #121212;         /* Haupt-Hintergrund (Schwarz) */
    --bg-secondary: #1e1e1e;       /* Header, Popups, Tabelle (Dunkelgrau) */
    --bg-tertiary: #2c2c2c;        /* Counter-Boxen, Input-Felder */
    --text-light: #eeeeee;         /* Haupt-Textfarbe */
    --text-secondary: #aaaaaa;     /* Sekund√§rer Text (Titel, etc.) */
    --accent-blue: #0a84ff;        /* Akzentfarbe (iOS Blue) */
    --border-color: #333333;       /* Haupt-Trennlinie */
    --table-line: #222222;         /* Tabellen-Trennung */
}

/* ====================================================================
   BASIS & TYPOGRAPHIE
   ==================================================================== */
body {
    margin: 0;
    background: var(--bg-primary);
    color: var(--text-light);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    overflow: hidden;
    overscroll-behavior: none;
    -webkit-tap-highlight-color: transparent;
}

/* ====================================================================
   TOP BAR (HEADER)
   ==================================================================== */
#topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 10px;
    background: var(--bg-secondary);
    box-shadow: 0 1px 4px rgba(0,0,0,0.5);
    z-index: 5000;
    padding-top: calc(env(safe-area-inset-top) + 10px);
}

#counterWrapper {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 8px;
}

.counter-box {
    padding: 8px;
    border-radius: 8px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    text-align: center;
}

.counter-title {
    font-size: 10px;
    color: var(--text-secondary);
    line-height: 1.2;
}

.counter-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-blue);
}

#search {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-light);
    box-sizing: border-box;
    font-size: 14px;
}

#buttonRow {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

#buttonRow button {
    flex: 1;
    padding: 8px;
    font-size: 12px;
    color: var(--accent-blue);
    border-radius: 10px;
    background: var(--bg-tertiary);
    border: none;
    font-weight: 600;
}

#buttonRow button:first-child {
    background: var(--accent-blue);
    color: white;
}

/* ====================================================================
   TABELLE & SCROLLING
   ==================================================================== */
#tableContainer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: auto;
    background: var(--bg-primary);
    z-index: 100;
    padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
}

table {
    width: 100%;
    min-width: 900px;
    border-collapse: collapse;
    background: var(--bg-secondary);
}

th {
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
    z-index: 200;
    padding: 8px 10px;
    color: var(--text-secondary);
    font-size: 10px;
    white-space: nowrap;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

td {
    padding: 6px 10px;
    font-size: 11px;
    border-bottom: 1px solid var(--table-line);
    white-space: nowrap;
    vertical-align: middle;
}

tr:nth-child(even) {
    background: #242424; /* Etwas dunkler als Secondary BG */
}

.iconCell span {
    cursor: pointer;
    margin-right: 10px;
    font-size: 14px;
    color: var(--accent-blue);
}

input.miniQty {
    width: 45px;
    background: var(--bg-tertiary);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    text-align: center;
    padding: 4px 2px;
    font-size: 11px;
}

/* ====================================================================
   ZUSTAND & SELEKTION
   ==================================================================== */
.tr-zero-stock {
    background: #401010 !important; /* Dunkelrot f√ºr 0 Bestand */
}

.selectedRow {
    background: #003a70 !important; /* Dunkelblau f√ºr Auswahl */
}

.marked {
    background: #505000 !important; /* Dunkelgelb/Olive f√ºr Markierung */
}

/* ====================================================================
   POPUPS (MODAL)
   ==================================================================== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7); /* Dunklerer Overlay */
    display: none;
    z-index: 9990;
}

#popup, #salePopup, #salesHistoryPopup, #viewPopup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    width: 400px;
    max-width: 90vw;
    overflow: hidden;
    z-index: 9999;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

.popup-row {
    margin-bottom: 12px;
    text-align: left;
}

.popup-row label {
    font-size: 12px;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.popup-row input, .popup-row textarea, .popup-row select {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-light);
    box-sizing: border-box;
}

#popupButtons, #saleButtons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

#popupButtons button, #saleButtons button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
}

#btnSave, #btnSaleOk {
    background: var(--accent-blue);
    color: white;
}

#btnCancel, #btnSaleCancel {
    background: var(--bg-tertiary);
    color: var(--text-light);
    border: 1px solid var(--border-color);
}
</style>
</head>

<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box">
      <div class="counter-title">Artikel</div>
      <div id="countArtikel" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Ges. Menge</div>
      <div id="countMenge" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Warenwert (‚Ç¨)</div>
      <div id="countWert" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Umsatz Jahr (‚Ç¨)</div>
      <div id="countUmsatzJahr" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Gewinn Ges. (‚Ç¨)</div>
      <div id="countGewinn" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Lagerort</div>
      <div id="countWertTotal" class="counter-value">Alle</div>
    </div>
  </div>

  <div id="searchRow"><input id="search" placeholder="Artikel / Nr. / Ort suchen ‚Ä¶"></div>

  <div id="buttonRow">
    <button id="btnAdd">‚ûï Neuer Artikel</button>
    <button id="btnSales">üßæ Verk√§ufe</button>
    <button id="btnExport">‚¨áÔ∏è Sichern</button>
    <button id="btnImport">‚¨ÜÔ∏è Laden</button>
  </div>
</div>

<div id="tableContainer">
<table>
<thead>
<tr class="table-header">
  <th>‚≠ê</th>          <th>Nr</th>          <th>Artikelname</th> <th>Menge</th>       <th>EK (‚Ç¨)</th>      <th>VK (‚Ç¨)</th>      <th>Gr√∂√üe</th>       <th>Zustand</th>     <th>Ort</th>         <th>Datum</th>       <th>Aktion</th>      </tr>
</thead>
<tbody id="tableBody">
</tbody>
</table>
</div>

<div id="modalOverlay" class="modal-overlay"></div>

<div id="popup">
    <h3>Artikeldetails</h3>
    <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
    <div class="popup-row"><label>Name</label><input id="p_name"></div>
    <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1" min="0"></div>
    <div class="popup-row"><label>Gr√∂√üe</label><input id="p_groesse"></div>
    <div class="popup-row"><label>Preis (Einkauf, pro St√ºck)</label><input type="number" id="p_preis" step="0.01" min="0"></div>
    <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
    <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
    <div class="popup-row">
        <label>Zustand</label>
        <select id="p_zustand">
            <option value="Neu">Neu</option>
            <option value="Gebraucht">Gebraucht</option>
        </select>
    </div>
    <div class="popup-row"><label>Bild (optional)</label><input type="file" id="p_bild" accept="image/*" capture="environment"></div>
    <div class="popup-row"><label>Notiz</label><textarea id="p_notiz"></textarea></div>
    <div id="popupButtons">
        <button id="btnSave">üíæ Speichern</button>
        <button id="btnCancel">‚ùå Abbrechen</button>
    </div>
</div>

<div id="viewPopup" class="popup"></div>

<div id="salePopup">
    <h3>Artikel verkaufen</h3>
    <div class="popup-row"><label>Rechnungsnummer</label><input id="s_rechnung"></div>
    <div class="popup-row"><label>Verkaufte Menge</label><input type="number" id="s_menge" min="1"></div>
    <div class="popup-row"><label>Verkaufspreis pro St√ºck (‚Ç¨)</label><input type="number" id="s_preis" step="0.01"></div>
    <div class="popup-row"><label>Versand vom Kunden (‚Ç¨)</label><input type="number" id="s_versandKunde" step="0.01"></div>
    <div class="popup-row"><label>Eigene Versandkosten (‚Ç¨)</label><input type="number" id="s_versandKosten" step="0.01"></div>
    <div class="popup-row"><label>Verkaufsdatum</label><input type="date" id="s_datum"></div>
    <div id="saleButtons">
        <button id="btnSaleOk">‚úÖ Verkaufen & Bestand reduzieren</button>
        <button id="btnSaleCancel">‚ùå Abbrechen</button>
    </div>
</div>

<div id="salesHistoryPopup">
    <h3>Verkaufs-Historie</h3>
    <input id="salesSearch" placeholder="Suche (Artikel, Nr., Rechnung)..." style="width:100%;margin-bottom:15px;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-light);">
    <div style="max-height: 40vh; overflow-y: auto;">
        <table style="min-width: 500px;">
            <thead>
                <tr><th>RG Nr.</th><th>Datum</th><th>Artikel Nr.</th><th>Name</th><th>Menge</th><th>Umsatz (‚Ç¨)</th><th>Gewinn (‚Ç¨)</th><th>Aktion</th></tr>
            </thead>
            <tbody id="salesBody"></tbody>
        </table>
    </div>
    <div style="margin-top:20px;text-align:right;">
        <button onclick="closeSalesHistory()" style="padding:10px 20px; background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-light); border-radius:10px;">Schlie√üen</button>
    </div>
</div>


<script>
// ====================================================================
// GLOBALE VARIABLEN & INIT 
// ====================================================================
let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");
let sales   = JSON.parse(localStorage.getItem("lagerSales") || "[]");
let editIndex = -1; 
let currentSaleIndex = -1; 
let editSaleIndex = -1; 

const DOM = {
    tableBody: document.getElementById("tableBody"),
    popup: document.getElementById("popup"),
    viewPopup: document.getElementById("viewPopup"),
    salePopup: document.getElementById("salePopup"),
    salesHistoryPopup: document.getElementById("salesHistoryPopup"),
    search: document.getElementById("search"),
    salesSearch: document.getElementById("salesSearch"),
    modalOverlay: document.getElementById("modalOverlay") 
};

document.addEventListener("DOMContentLoaded", () => {
    initArtNrCounter();
    renderTable();
    setupEventListeners();
});

// ====================================================================
// ART-NR LOGIK
// ====================================================================

function initArtNrCounter(){
    const jahr = new Date().getFullYear();
    const key  = "artnrCounter_" + jahr;
    if (localStorage.getItem(key) !== null) return;
    let max = -1;
    artikel.forEach(a=>{
        if(!a.artnr) return;
        const m = a.artnr.match(/^(\d{3})-(\d{4})$/);
        if(m && Number(m[2]) === jahr){
            max = Math.max(max, Number(m[1]));
        }
    });
    localStorage.setItem(key, max);
}

function previewNextArtNr(){
    const jahr = new Date().getFullYear();
    const key  = "artnrCounter_" + jahr;
    const val  = Number(localStorage.getItem(key) || -1) + 1;
    return String(val).padStart(3,"0") + "-" + jahr;
}

function commitNextArtNr(){
    const jahr = new Date().getFullYear();
    const key  = "artnrCounter_" + jahr;
    let counter = Number(localStorage.getItem(key) || -1) + 1;
    localStorage.setItem(key, counter);
    return String(counter).padStart(3,"0") + "-" + jahr;
}

// ====================================================================
// DATENBANK & EXPORT
// ====================================================================

function autoBackup(reason){
    const data = { artikel, sales };
    const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
    const a    = document.createElement("a");
    a.href     = URL.createObjectURL(blob);
    a.download = `lager_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

// ***************************************************************
// MODIFIZIERTE IMPORT-FUNKTION F√úR MAXIMALE KOMPATIBILIT√ÑT
// ***************************************************************
function handleImport(){
    const inp = document.createElement("input");
    inp.type  = "file";
    inp.accept= "*/*"; // Erlaubt alle Dateitypen, muss aber JSON-Inhalt sein!

    inp.onchange = e => {
        const file = e.target.files[0];
        if(!file) return;

        const r = new FileReader();
        r.onload = () => {
            try{
                const data = JSON.parse(r.result);
                
                // Pr√ºft, ob es das vollst√§ndige Backup-Format ist ({artikel: [], sales: []})
                if(data.artikel && Array.isArray(data.artikel)){
                    artikel = data.artikel;
                    sales   = data.sales || [];
                // Pr√ºft, ob es nur eine reine Artikelliste ist
                } else if(Array.isArray(data)){
                    artikel = data;
                    sales   = [];
                } else {
                    alert("Unbekanntes Dateiformat! Bitte eine g√ºltige JSON-Backup-Datei w√§hlen (Format: {artikel:[...], sales:[...]}).");
                    return;
                }
                
                localStorage.setItem("lagerData", JSON.stringify(artikel));
                localStorage.setItem("lagerSales", JSON.stringify(sales));
                initArtNrCounter();
                renderTable();
                alert("Daten erfolgreich geladen ‚úî");
            }catch(error){
                console.error("Import-Fehler:", error);
                alert("Datei konnte nicht gelesen werden. Stellen Sie sicher, dass es eine g√ºltige JSON-Backup-Datei ist.");
            }
        };
        r.readAsText(file);
    };
    inp.click();
}

// ====================================================================
// UI-RENDERING & Z√ÑHLER (UNVER√ÑNDERT)
// ====================================================================

function adjustTableTop(){
    const header = document.getElementById("topbar");
    const tableC = document.getElementById("tableContainer");
    tableC.style.top = header.offsetHeight + "px";
}
window.addEventListener("resize", adjustTableTop);

function renderTable(){
    DOM.tableBody.innerHTML = "";
    
    const sortedArtikel = [...artikel].sort((a, b) => {
        if (a.markiert && !b.markiert) return -1;
        if (!a.markiert && b.markiert) return 1;
        return (a.name || "").localeCompare(b.name || "");
    });

    sortedArtikel.forEach((a, i) => {
        const originalIndex = artikel.findIndex(item => item === a);
        if(!a) return;

        const tr = document.createElement("tr");
        tr.onclick = () => selectRow(originalIndex);
        if(a.markiert) tr.classList.add("marked");
        
        if(a.menge === 0){
            tr.classList.add("tr-zero-stock");
        }
        
        const maxVK = sales
            .filter(s => s.artnr === a.artnr)
            .reduce((max, s) => Math.max(max, s.verkaufPreis || 0), 0);

        tr.innerHTML = `
            <td onclick="event.stopPropagation(); toggleMark(${originalIndex})">${a.markiert ? "‚≠ê" : "‚òÜ"}</td>
            <td>${a.artnr || ""}</td>
            <td>${a.name || ""}</td>
            <td><input class="miniQty" type="number" value="${a.menge}" oninput="updateQty(${originalIndex}, this.value)"></td>
            <td>${isNaN(a.preis) ? "" : a.preis.toFixed(2)}</td>
            <td>${maxVK > 0 ? maxVK.toFixed(2) : ""}</td>
            <td>${a.groesse || ""}</td>
            <td>${a.zustand || ""}</td>
            <td>${a.ort || ""}</td>
            <td>${a.datum ? formatDate(a.datum) : ""}</td>
            <td class="iconCell">
                <span onclick="event.stopPropagation(); viewImg(${originalIndex})" style="opacity:${a.bild ? 1 : 0.3}">üì∑</span>
                <span onclick="event.stopPropagation(); viewNote(${originalIndex})" style="opacity:${a.notiz ? 1 : 0.3}">üìù</span>
                <span onclick="event.stopPropagation(); editArtikel(${originalIndex})">‚úèÔ∏è</span>
                <span onclick="event.stopPropagation(); sellArtikel(${originalIndex})">üõí</span>
                <span onclick="event.stopPropagation(); del(${originalIndex})">üóë</span>
            </td>
        `;

        DOM.tableBody.appendChild(tr);
    });

    updateCounters();
    adjustTableTop();
}

function updateCounters(){
    let gesamtMenge = 0;
    let gesamtEKWert = 0;
    artikel.forEach(a=>{
        gesamtMenge += a.menge || 0;
        gesamtEKWert += (a.menge || 0) * (a.preis || 0);
    });

    let umsatzJahr = 0;
    let gewinnGesamt = 0;
    const currentYear = new Date().getFullYear();

    sales.forEach(s=>{
        const u = s.umsatz || 0;
        const g = s.gewinn || 0;
        gewinnGesamt += g;
        if(s.datum && parseInt(s.datum.slice(0,4),10) === currentYear) {
            umsatzJahr += u;
        }
    });

    document.getElementById("countArtikel").textContent   = artikel.filter(a=>a && a.menge>0).length;
    document.getElementById("countMenge").textContent     = gesamtMenge;
    document.getElementById("countWert").textContent      = gesamtEKWert.toFixed(2);
    document.getElementById("countUmsatzJahr").textContent= umsatzJahr.toFixed(2);
    document.getElementById("countGewinn").textContent    = gewinnGesamt.toFixed(2);

    const umsatzElm = document.getElementById("countUmsatzJahr");
    umsatzElm.style.color = "var(--accent-blue)";
    if(umsatzJahr >= 25000){
        umsatzElm.style.color = "#ff453a"; // iOS Red
    } else if(umsatzJahr >= 22000){
        umsatzElm.style.color = "#ff9f0a"; // iOS Orange
    }
}

// ====================================================================
// AKTIONEN IN DER TABELLE (UNVER√ÑNDERT)
// ====================================================================

function updateQty(i, val){
    artikel[i].menge = parseInt(val) || 0;
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    renderTable();
}

function toggleMark(i){
    artikel[i].markiert = !artikel[i].markiert;
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    renderTable();
}

function selectRow(i){
    const clickedElement = DOM.tableBody.children[i];
    document.querySelectorAll(".selectedRow").forEach(el => el.classList.remove("selectedRow"));
    if (clickedElement) {
        clickedElement.classList.add("selectedRow");
    }
}

function del(i){
    if(confirm("Wirklich l√∂schen?")){
        artikel.splice(i,1);
        localStorage.setItem("lagerData", JSON.stringify(artikel));
        renderTable();
    }
}

function viewImg(i){
    const a = artikel[i];
    DOM.viewPopup.innerHTML = `
        <h3>Bild Vorschau</h3>
        ${a.bild ? `<img src="${a.bild}" style="max-width:100%; height:auto; border-radius:8px;">` : `<div>Kein Bild vorhanden.</div>`}
        <br><button onclick="closeViewPopup()">Schlie√üen</button>
    `;
    DOM.viewPopup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function viewNote(i){
    const a = artikel[i];
    DOM.viewPopup.innerHTML = `
        <h3>Notiz</h3>
        <div>${a.notiz || "Keine Notiz vorhanden."}</div>
        <br><button onclick="closeViewPopup()">Schlie√üen</button>
    `;
    DOM.viewPopup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function closeViewPopup() {
    DOM.viewPopup.style.display = "none";
    DOM.modalOverlay.style.display = "none";
}

// ====================================================================
// ARTIKEL BEARBEITEN / NEU HINZUF√úGEN (UNVER√ÑNDERT)
// ====================================================================

function editArtikel(i){
    const a = artikel[i] || {};
    editIndex = i;

    document.getElementById("p_artnr").value    = a.artnr || "";
    document.getElementById("p_name").value     = a.name || "";
    document.getElementById("p_menge").value    = a.menge !== undefined ? a.menge : 1;
    document.getElementById("p_groesse").value  = a.groesse || "";
    document.getElementById("p_preis").value    = a.preis || 0;
    document.getElementById("p_ort").value      = a.ort || "";
    document.getElementById("p_datum").value    = a.datum || "";
    document.getElementById("p_zustand").value  = a.zustand || "Neu";
    document.getElementById("p_notiz").value    = a.notiz || "";
    document.getElementById("p_bild").value = null;

    DOM.popup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function saveArtikel(){
    const input = {
        artnr:  document.getElementById("p_artnr").value.trim(),
        name:   document.getElementById("p_name").value.trim(),
        menge: +document.getElementById("p_menge").value || 0,
        groesse:document.getElementById("p_groesse").value.trim(),
        preis: +document.getElementById("p_preis").value || 0,
        ort:    document.getElementById("p_ort").value.trim(),
        datum:  document.getElementById("p_datum").value,
        zustand:document.getElementById("p_zustand").value || "Neu",
        notiz:  document.getElementById("p_notiz").value.trim(),
        bild:   null
    };
    
    if (input.name.length === 0) {
        alert("Der Artikel muss einen Namen haben!");
        return;
    }

    const file = document.getElementById("p_bild").files[0];
    const itemToSave = (editIndex === -1) ? createNewItem(input) : updateExistingItem(input);

    if (file) {
        const r = new FileReader();
        r.onload = e => {
            itemToSave.bild = e.target.result;
            finalizeSave(itemToSave);
        };
        r.readAsDataURL(file);
    } else {
        if (editIndex !== -1) {
            itemToSave.bild = artikel[editIndex].bild;
        } else {
            itemToSave.bild = "";
        }
        finalizeSave(itemToSave);
    }
}

function createNewItem(input) {
    const nextNr = commitNextArtNr();
    return {
        ...input,
        artnr: input.artnr || nextNr,
        markiert: false
    };
}

function updateExistingItem(input) {
    const alt = artikel[editIndex];
    return {
        ...input,
        artnr: input.artnr || alt.artnr,
        markiert: alt.markiert || false
    };
}

function finalizeSave(item) {
    if (editIndex === -1) {
        artikel.push(item);
    } else {
        artikel[editIndex] = item;
    }
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    DOM.popup.style.display = "none";
    DOM.modalOverlay.style.display = "none";
    editIndex = -1;
    renderTable();
}

function openAddArtikel() {
    editIndex = -1;
    document.getElementById("p_artnr").value    = previewNextArtNr();
    document.getElementById("p_name").value     = "";
    document.getElementById("p_menge").value    = 1;
    document.getElementById("p_groesse").value  = "";
    document.getElementById("p_preis").value    = 0;
    document.getElementById("p_ort").value      = "";
    document.getElementById("p_datum").value    = new Date().toISOString().slice(0, 10);
    document.getElementById("p_zustand").value  = "Neu";
    document.getElementById("p_notiz").value    = "";
    document.getElementById("p_bild").value     = null;

    DOM.popup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function cancelArtikel(){
    DOM.popup.style.display = "none";
    DOM.modalOverlay.style.display = "none";
    editIndex = -1;
}

// ====================================================================
// VERKAUFSLOGIK (UNVER√ÑNDERT)
// ====================================================================

function nextInvoiceNrLager(){
    const key = "invoiceCounter";
    let c = parseInt(localStorage.getItem(key) || "0",10) + 1;
    localStorage.setItem(key, c);
    return String(c).padStart(5,"0");
}

function sellArtikel(i){
    currentSaleIndex = i;
    editSaleIndex    = -1;
    const a = artikel[i];
    
    document.getElementById("s_menge").value        = a.menge || 1;
    document.getElementById("s_preis").value        = "";
    document.getElementById("s_versandKunde").value = 0;
    document.getElementById("s_versandKosten").value= 0;
    document.getElementById("s_datum").value        = new Date().toISOString().slice(0,10);
    document.getElementById("s_rechnung").value     = nextInvoiceNrLager();
    document.getElementById("s_menge").disabled     = false;

    DOM.salePopup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function confirmSale(){
    const mengeV = parseInt(document.getElementById("s_menge").value) || 0;
    const preisV = parseFloat(document.getElementById("s_preis").value) || 0;
    const versK  = parseFloat(document.getElementById("s_versandKunde").value) || 0;
    const versC  = parseFloat(document.getElementById("s_versandKosten").value) || 0;
    const datV   = document.getElementById("s_datum").value;
    const rNr    = document.getElementById("s_rechnung").value || "";

    if (editSaleIndex >= 0) {
        const s = sales[editSaleIndex];
        if(!s) return;
        
        s.verkaufPreis = preisV;
        s.versandKunde = versK;
        s.versandKosten= versC;
        s.datum        = datV;
        s.rechnungsnr  = rNr;

        const umsatzNeu = s.menge * s.verkaufPreis + s.versandKunde;
        const einkaufNeu= s.menge * (s.einkaufPreis || 0);
        s.umsatz = umsatzNeu;
        s.gewinn = umsatzNeu - einkaufNeu - s.versandKosten;

        localStorage.setItem("lagerSales", JSON.stringify(sales));
        closeSalePopup();
        openSalesHistory();
        updateCounters();
        return;

    } else if (currentSaleIndex !== -1) {
        const a = artikel[currentSaleIndex];

        if(mengeV <= 0 || mengeV > a.menge){
            alert("Verkaufte Menge ist ung√ºltig oder √ºbersteigt den Bestand.");
            return;
        }

        const umsatz = mengeV * preisV + versK;
        const einkaufKosten = mengeV * (a.preis || 0);
        const gewinn = umsatz - einkaufKosten - versC;

        const sale = {
            artnr: a.artnr,
            name:  a.name,
            menge: mengeV,
            verkaufPreis: preisV,
            versandKunde: versK,
            versandKosten: versC,
            einkaufPreis: a.preis || 0,
            datum: datV,
            umsatz,
            gewinn,
            rechnungsnr: rNr
        };

        sales.push(sale);
        localStorage.setItem("lagerSales", JSON.stringify(sales));

        a.menge -= mengeV;
        localStorage.setItem("lagerData", JSON.stringify(artikel));

        closeSalePopup();
        renderTable();
    }
}

function closeSalePopup(){
    DOM.salePopup.style.display = "none";
    DOM.modalOverlay.style.display = "none";
    currentSaleIndex = -1;
    editSaleIndex = -1;
}

// ====================================================================
// VERKAUFSHISTORIE & STORNOS (UNVER√ÑNDERT)
// ====================================================================

function openSalesHistory(){
    renderSalesList(DOM.salesSearch.value);
    DOM.salesHistoryPopup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function renderSalesList(filter){
    const tbody = document.getElementById("salesBody");
    if(!tbody) return;
    tbody.innerHTML = "";
    const q = (filter || "").toLowerCase();

    sales.slice().reverse().forEach((s,idx)=>{
        const originalIndex = sales.length - 1 - idx;
        const txt = (s.name||"") + " " + (s.artnr||"") + " " + (s.rechnungsnr||"") + " " + (s.datum||"");
        if(q && !txt.toLowerCase().includes(q)) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.rechnungsnr || ""}</td>
            <td>${s.datum ? formatDate(s.datum) : ""}</td>
            <td>${s.artnr || ""}</td>
            <td>${s.name || ""}</td>
            <td>${s.menge || 0}</td>
            <td>${(s.umsatz||0).toFixed(2)}</td>
            <td>${(s.gewinn||0).toFixed(2)}</td>
            <td>
                <button onclick="editSale(${originalIndex})">‚úèÔ∏è</button>
                <button onclick="stornoSale(${originalIndex})">‚§¥Ô∏è</button>
                <button onclick="deleteSale(${originalIndex})">üóë</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function stornoSale(index){
    const s = sales[index];
    if(!s) return;
    if(!confirm(`Verkauf von ${s.menge}x ${s.name} stornieren und Bestand wieder erh√∂hen?`)) return;

    const art = artikel.find(a => a.artnr === s.artnr);
    if(art){
        art.menge = (art.menge || 0) + (s.menge || 0);
    }else{
        artikel.push({
            artnr: s.artnr,
            name: s.name,
            menge: s.menge || 0,
            preis: s.einkaufPreis || 0,
            notiz:"Storno-Wiederherstellung",
            markiert:false
        });
    }

    sales.splice(index,1);
    localStorage.setItem("lagerSales", JSON.stringify(sales));
    localStorage.setItem("lagerData", JSON.stringify(artikel));

    openSalesHistory();
    renderTable();
}

function deleteSale(index){
    if(!confirm("Verkauf endg√ºltig aus der Liste l√∂schen?")) return;
    sales.splice(index,1);
    localStorage.setItem("lagerSales", JSON.stringify(sales));
    openSalesHistory();
    updateCounters();
}

function editSale(index){
    const s = sales[index];
    if(!s) return;

    editSaleIndex    = index;
    currentSaleIndex = -1;

    document.getElementById("s_menge").value        = s.menge || 1;
    document.getElementById("s_preis").value        = s.verkaufPreis || 0;
    document.getElementById("s_versandKunde").value = s.versandKunde || 0;
    document.getElementById("s_versandKosten").value= s.versandKosten || 0;
    document.getElementById("s_datum").value        = s.datum || new Date().toISOString().slice(0,10);
    document.getElementById("s_rechnung").value     = s.rechnungsnr || "";

    document.getElementById("s_menge").disabled = true;

    DOM.salePopup.style.display = "block";
    DOM.modalOverlay.style.display = "block";
}

function closeSalesHistory(){
    DOM.salesHistoryPopup.style.display = "none";
    DOM.modalOverlay.style.display = "none";
}

// ====================================================================
// HILFSFUNKTIONEN & EVENTS (UNVER√ÑNDERT)
// ====================================================================

function formatDate(d){
    if(!d) return "";
    const [y,m,dd] = d.split("-");
    return `${dd}-${m}-${y}`;
}

function setupEventListeners() {
    document.getElementById("btnAdd").onclick = openAddArtikel;
    document.getElementById("btnExport").onclick = () => autoBackup("manuell");
    document.getElementById("btnImport").onclick = handleImport;
    document.getElementById("btnSales").onclick = openSalesHistory;
    
    document.getElementById("btnSave").onclick = saveArtikel;
    document.getElementById("btnCancel").onclick = cancelArtikel;
    
    document.getElementById("btnSaleOk").onclick = confirmSale;
    document.getElementById("btnSaleCancel").onclick = closeSalePopup;

    DOM.search.oninput = () => {
        const q = DOM.search.value.toLowerCase();
        DOM.tableBody.querySelectorAll("tr").forEach(r=>{
            r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
        });
    };
    
    DOM.salesSearch.oninput = () => renderSalesList(DOM.salesSearch.value);

    DOM.modalOverlay.onclick = () => {
        if (DOM.popup.style.display === "block") cancelArtikel();
        if (DOM.salePopup.style.display === "block") closeSalePopup();
        if (DOM.salesHistoryPopup.style.display === "block") closeSalesHistory();
        if (DOM.viewPopup.style.display === "block") closeViewPopup();
    };

    adjustTableTop();
}
</script>
</body>
</html>
