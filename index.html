<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Lager App ‚Äì Stabil (Artikel + Persistenz + Foto/Notiz im Artikel)</title>
<style>
:root{--bg:#000;--panel:#0b0b0b;--panel2:#111;--border:#333;--muted:#aaa;--text:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,system-ui,sans-serif;padding-top:0;-webkit-text-size-adjust:100%}
button,input,select,textarea{font:inherit;color:inherit}
button{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:5px 6px;font-size:10px}
input,select,textarea{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:4px 6px;color:#fff;width:100%}
textarea{min-height:80px;resize:vertical}

.topbar{position:fixed;top:0;left:0;right:0;z-index:5000;background:#000;border-bottom:1px solid #333;padding:6px 8px;padding-top:calc(6px + env(safe-area-inset-top));}
.actions{display:flex;gap:4px}
.actions button{flex:1}

.content{padding:8px}


/* Make table compact */
.gridHeader,.gridRow{
  display:grid;
  grid-template-columns:
    44px
    minmax(170px,1fr)
    38px
    44px
    78px
    110px
    58px
    70px
    54px;
  gap:2px;               /* <<< kompakter */
  align-items:center;
}

.gridHeader{
  position:sticky;
  top:52px;              /* wird per JS gesetzt */
  z-index:9999;          /* <<< sicher √ºber Zeilen */
  background:#000;       /* <<< deckend, damit nichts dr√ºber liegt */
  border-bottom:1px solid #333;
  font-size:9px;
  padding:2px 0;
  white-space:nowrap;
}

.gridRow{
  padding:1px 0;
  border-bottom:1px solid #2a2a2a;
  font-size:9px;
  white-space:nowrap; /* KEIN Umbruch */
}

.name{
  font-size:9px;
  line-height:1.0;
  overflow:hidden;
  text-overflow:ellipsis;
}

.qty{width:34px;text-align:center;padding:1px 3px;font-size:9px;border-radius:7px}
.small{font-size:9px;color:#ddd;overflow:hidden;text-overflow:ellipsis}
.icoBar{display:flex;gap:3px;justify-content:flex-end}
.ico{
  width:20px;height:20px;border:1px solid #333;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  user-select:none;-webkit-tap-highlight-color:transparent;
}
.ico:active{transform:scale(.98)}
.ico.muted{opacity:.35}

/* Modals */
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000;overflow:hidden}
.box{
  background:#0b0b0b;border:1px solid #333;border-radius:12px;
  width:92%;max-width:480px;margin:7vh auto;padding:10px;
  max-height:82vh;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}
.box h3{margin:0 0 6px;font-size:12px}
.box label{font-size:9px;color:#aaa;margin-top:6px;display:block}

.row2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.btnRow{display:flex;gap:6px;margin-top:10px}
.btnRow button{flex:1}

.preview{
  margin-top:8px;
  border:1px solid #333;border-radius:10px;
  overflow:hidden;
  display:none;
}
.preview img{display:block;width:100%;height:auto;max-height:180px;object-fit:contain}

.hint{color:var(--muted);font-size:9px;line-height:1.25;margin-top:8px}

/* --- TABLE LAYOUT (STABIL: Sticky Header + Horizontal Scroll Sync) --- */
.tableOuter{}
.rowsWrap{
  overflow-x:auto;
  overflow-y:visible;
  -webkit-overflow-scrolling:touch;
}
/* fixed column widths for perfect alignment */
:root{
  --cols: 44px 220px 38px 44px 78px 110px 58px 70px 54px;
  --gap: 2px;
  --topOffset: 58px; /* will be set by JS */
}
.gridHeaderSticky{
  position:fixed;
  left:0; right:0;
  top: var(--topOffset);
  z-index: 4500;           /* unter Topbar (5000), √ºber Zeilen */
  background:#000;
  border-bottom:1px solid #333;
  padding:2px 8px;         /* links/rechts wie Content */
  overflow:hidden;
  pointer-events:none;     /* Scroll-Gesten nicht blockieren */
}
.gridHeaderInner{pointer-events:none;
pointer-events:none;

  display:grid;
  grid-template-columns: var(--cols);
  gap: var(--gap);
  align-items:center;
  font-size:9px;
  white-space:nowrap;
  will-change: transform;
}
..gridRow{
  display:grid;
  grid-template-columns: var(--cols);
  gap: var(--gap);
  align-items:center;
  padding:1px 0;
  border-bottom:1px solid #2a2a2a;
  font-size:9px;
  white-space:nowrap;
}
/* ensure rows have same min width so horizontal scroll exists */
.gridHeaderInner, .gridRow{min-width: calc(44px + 220px + 38px + 44px + 78px + 110px + 58px + 70px + 54px + (8 * var(--gap)));}


</style>
</head>

<body>

<div class="topbar" id="topbar">
  <div class="actions">
    <button id="btnAdd">+ Artikel</button>
    <button id="btnSalesTop">Verk√§ufe</button>
    <button id="btnSave">Sichern</button>
    <button id="btnLoad">Laden</button>
    <button id="btnPDF">PDF</button>
  </div>
</div>


<div class="content">
  <div class="tableOuter">
    <div class="gridHeaderSticky" id="gridHeaderSticky">
      <div class="gridHeaderInner" id="gridHeaderInner">
        <div>Nr</div>
        <div>Artikel</div>
        <div>Menge</div>
        <div>EK</div>
        <div>Kaufdatum</div>
        <div>Wo gekauft</div>
        <div>Gr√∂√üe</div>
        <div>Zustand</div>
        <div>Info</div>
      </div>
    </div>

    <div class="rowsWrap" id="rowsWrap">
      <div id="table" class="rowsInner"></div>
    </div>
  </div>
  <div class="hint">Lange Artikel / ‚ÄûWo gekauft‚Äú bleiben 1-zeilig. Wenn etwas abgeschnitten ist: Tabelle seitlich scrollen.</div>
</div>


<!-- Artikel anlegen/bearbeiten (inkl. Notiz & Foto) -->
<div id="modal">
 <div class="box">
  <h3 id="modalTitle">Artikel anlegen</h3>

  <label>Artikelname</label>
  <input id="mName" autocomplete="off">

  <div class="row2">
    <div>
      <label>Menge</label>
      <input id="mQty" type="number" inputmode="numeric" value="1">
    </div>
    <div>
      <label>EK</label>
      <input id="mEK" type="number" inputmode="decimal" value="0">
    </div>
  </div>

  <label>Kaufdatum</label>
  <input id="mDate" type="date">

  <label>Wo gekauft</label>
  <input id="mShop" autocomplete="off">

  <div class="row2">
    <div>
      <label>Gr√∂√üe</label>
      <input id="mSize" autocomplete="off">
    </div>
    <div>
      <label>Zustand</label>
      <select id="mState">
        <option>Neu</option>
        <option>Neuwertig</option>
        <option>Gebraucht</option>
      </select>
    </div>
  </div>

  <label>Notiz</label>
  <textarea id="mNote" placeholder="Notiz‚Ä¶"></textarea>

  <label style="margin-top:10px">Foto</label>
  <!-- Kein capture -> iOS bietet Auswahl (nicht automatisch Kamera) -->
  <input id="mPhoto" type="file" accept="image/*">
  <div class="preview" id="photoPreview"><img id="photoImg" alt="Foto Vorschau"></div>

  <div class="btnRow">
    <button id="mSave">Speichern</button>
    <button id="mCancel">Abbrechen</button>
  </div>
 </div>
</div>

<script>
/* ===================== DATEN + PERSISTENZ ===================== */
const LS_KEY = "lager_items_v2";
const LS_SALES_KEY = "lager_sales_v1";
let items = [];
let sales = [];
let editIndex = null;

const table = document.getElementById("table");

function normalizeItems(arr){
  return arr.map(x=>({
    name: String(x.name ?? ""),
    qty: Number(x.qty ?? 0),
    ek: Number(x.ek ?? 0),
    date: String(x.date ?? ""),
    shop: String(x.shop ?? ""),
    size: String(x.size ?? ""),
    state: String(x.state ?? "Neu"),
    note: String(x.note ?? ""),
    photo: String(x.photo ?? "")
  }));
}

function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(items)); }
  catch(e){ alert("Speichern im Ger√§t nicht m√∂glich (Speicher voll?)."); }
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) items = normalizeItems(parsed);
    }

function saveSalesLocal(){
  try{ localStorage.setItem(LS_SALES_KEY, JSON.stringify(sales)); }catch(e){}
}
function loadSalesLocal(){
  try{
    const raw = localStorage.getItem(LS_SALES_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) sales = parsed;
    }
  }catch(e){}
}
function nextSaleNumber(dateStr){
  const year = (dateStr && dateStr.length>=4) ? dateStr.slice(0,4) : String(new Date().getFullYear());
  const count = sales.filter(s=>String(s.date||"").startsWith(year)).length + 1;
  return String(count).padStart(3,"0") + "-" + year;
}
  }catch(e){}
}

/* ===================== RENDER ===================== */
function esc(s){
  return String(s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

function render(){
  table.innerHTML = "";
  items.forEach((a,i)=>{
    const hasNote = (a.note||"").trim().length>0;
    const hasPhoto = (a.photo||"").trim().length>0;

    const row = document.createElement("div");
    row.className = "gridRow";
    row.innerHTML = `
      <div>${String(i+1).padStart(3,"0")}</div>
      <div class="name" title="${esc(a.name)}">${esc(a.name)}</div>
      <div><input class="qty" data-i="${i}" type="number" inputmode="numeric" value="${Number(a.qty)||0}"></div>
      <div class="small" title="${(Number(a.ek)||0).toFixed(2)}">${(Number(a.ek)||0).toFixed(2)}</div>
      <div class="small" title="${esc(a.date)}">${esc(a.date)}</div>
      <div class="small" title="${esc(a.shop)}">${esc(a.shop)}</div>
      <div class="small" title="${esc(a.size)}">${esc(a.size)}</div>
      <div class="small" title="${esc(a.state)}">${esc(a.state)}</div>
      <div class="icoBar">
        <div class="ico ${hasPhoto?'':'muted'}" data-act="photo" data-i="${i}" title="Foto">üì∑</div>
        <div class="ico ${hasNote?'':'muted'}" data-act="note" data-i="${i}" title="Notiz">üìù</div>
        <div class="ico" data-act="sale" data-i="${i}" title="Verkaufen">üõí</div>
        <div class="ico" data-act="edit" data-i="${i}" title="Bearbeiten">‚úèÔ∏è</div>
      </div>
    `;
    table.appendChild(row);
  });

  // Menge nur bei change (nicht bei jedem Tastendruck)
  table.querySelectorAll("input.qty").forEach(inp=>{
    inp.addEventListener("change", (e)=>{
      const idx = Number(e.target.dataset.i);
      items[idx].qty = Number(e.target.value || 0);
      saveLocal();
    });
  });

  table.querySelectorAll(".ico").forEach(ico=>{
    ico.addEventListener("click", ()=>{
      const idx = Number(ico.dataset.i);
      const act = ico.dataset.act;
      if(act==="sale") openSale(idx);
      else openEdit(idx, act);
    });
  });
}

/* ===================== MODAL (Artikel + Notiz + Foto) ===================== */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const mName = document.getElementById("mName");
const mQty = document.getElementById("mQty");
const mEK = document.getElementById("mEK");
const mDate = document.getElementById("mDate");
const mShop = document.getElementById("mShop");
const mSize = document.getElementById("mSize");
const mState = document.getElementById("mState");
const mNote = document.getElementById("mNote");
const mPhoto = document.getElementById("mPhoto");
const photoPreview = document.getElementById("photoPreview");
const photoImg = document.getElementById("photoImg");

let modalPhotoData = ""; // dataURL im Dialog

function resetPhotoUI(){
  mPhoto.value = "";
  if(modalPhotoData){
    photoImg.src = modalPhotoData;
    photoPreview.style.display = "block";
  }else{
    photoPreview.style.display = "none";
    photoImg.removeAttribute("src");
  }
}

document.getElementById("btnAdd").addEventListener("click", ()=>{
  editIndex = null;
  modalTitle.textContent = "Artikel anlegen";
  mName.value=""; mQty.value=1; mEK.value=0;
  mDate.value=""; mShop.value=""; mSize.value=""; mState.value="Neu";
  mNote.value="";
  modalPhotoData="";
  resetPhotoUI();
  modal.style.display="block";
});

document.getElementById("mCancel").addEventListener("click", ()=>{
  modal.style.display="none";
});

function openEdit(i, act){
  editIndex = i;
  const a = items[i];
  modalTitle.textContent = "Artikel bearbeiten";
  mName.value=a.name||"";
  mQty.value=Number(a.qty)||0;
  mEK.value=Number(a.ek)||0;
  mDate.value=a.date||"";
  mShop.value=a.shop||"";
  mSize.value=a.size||"";
  mState.value=a.state||"Neu";
  mNote.value=a.note||"";
  modalPhotoData=a.photo||"";
  resetPhotoUI();
  modal.style.display="block";

  // Wenn Nutzer direkt auf üìù oder üì∑ klickt -> automatisch dahin scrollen
  if(act==="note"){ setTimeout(()=>mNote.scrollIntoView({behavior:"smooth",block:"center"}), 50); }
  if(act==="photo"){ setTimeout(()=>mPhoto.scrollIntoView({behavior:"smooth",block:"center"}), 50); }
}

mPhoto.addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    modalPhotoData = String(r.result||"");
    resetPhotoUI();
  };
  r.readAsDataURL(f);
});

document.getElementById("mSave").addEventListener("click", ()=>{
  const obj = {
    name:(mName.value||"").trim(),
    qty:Number(mQty.value||0),
    ek:Number(mEK.value||0),
    date:mDate.value||"",
    shop:(mShop.value||"").trim(),
    size:(mSize.value||"").trim(),
    state:mState.value||"Neu",
    note:(mNote.value||"").trim(),
    photo:modalPhotoData||""
  };
  if(!obj.name){ alert("Bitte Artikelname eingeben."); return; }

  if(editIndex===null) items.push(obj);
  else items[editIndex] = obj;

  saveLocal();
  modal.style.display="none";
  render();
  adjust();
});


/* ===================== VERKAUF MODAL ===================== */
const saleModal = document.getElementById("saleModal");
const saleTitle = document.getElementById("saleTitle");
const sNumber = document.getElementById("sNumber");
const sDate = document.getElementById("sDate");
const sPlace = document.getElementById("sPlace");
const sQty = document.getElementById("sQty");
const sPrice = document.getElementById("sPrice");
const sShip = document.getElementById("sShip");
const sHint = document.getElementById("sHint");
let saleIndex = null;

function todayISO(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return d.getFullYear()+"-"+m+"-"+day;
}

function openSale(i){
  saleIndex = i;
  const a = items[i];
  saleTitle.textContent = "Verkauf ‚Äì " + String(i+1).padStart(3,"0") + " ‚Äì " + (a.name||"");
  const d = todayISO();
  sDate.value = d;
  sNumber.value = nextSaleNumber(d);
  sPlace.value = "";
  sQty.value = Math.min(1, Number(a.qty||0) || 0);
  sPrice.value = 0;
  sShip.value = 0;
  sHint.textContent = "Bestand aktuell: " + (Number(a.qty)||0) + " (Speichern zieht die Menge ab)";
  saleModal.style.display = "block";
}

document.getElementById("sCancel").addEventListener("click", ()=>{
  saleModal.style.display = "none";
});

document.getElementById("sSave").addEventListener("click", ()=>{
  if(saleIndex===null) return;
  const a = items[saleIndex];
  const qty = Number(sQty.value||0);
  if(!qty || qty<=0){ alert("Bitte Menge > 0 eingeben."); return; }
  const current = Number(a.qty||0);
  if(qty>current){ alert("Menge zu hoch. Bestand: " + current); return; }

  const rec = {
    number: (sNumber.value||"").trim() || nextSaleNumber(sDate.value||todayISO()),
    date: sDate.value || todayISO(),
    place: (sPlace.value||"").trim(),
    itemNr: String(saleIndex+1).padStart(3,"0"),
    itemName: a.name||"",
    qty: qty,
    price: Number(sPrice.value||0),
    ship: Number(sShip.value||0),
    ek: Number(a.ek||0)
  };
  sales.push(rec);

  // Bestand abziehen
  a.qty = current - qty;

  saveLocal();
  saveSalesLocal();
  // falls Verk√§ufe-√úbersicht offen ist, aktualisieren
  try{ if(document.getElementById('salesModal') && document.getElementById('salesModal').style.display==='block'){ renderSales(); } }catch(e){}
  saleModal.style.display = "none";
  render();
  adjust();
});

/* ===================== IMPORT / EXPORT ===================== */
document.getElementById("btnSave").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lager_backup.json";
  a.click();
});

document.getElementById("btnLoad").addEventListener("click", ()=>{
  const i = document.createElement("input");
  i.type="file"; i.accept="application/json";
  i.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const parsed = JSON.parse(r.result);
        if(!Array.isArray(parsed)) throw new Error("Format falsch");
        items = normalizeItems(parsed);
        saveLocal();
        render();
        adjust();
      }catch(err){
        alert("Datei konnte nicht gelesen werden.");
      }
    };
    r.readAsText(f);
  };
  i.click();
});

/* ===================== PDF (noch sp√§ter) ===================== */
document.getElementById("btnPDF").addEventListener("click", ()=>{
  alert("PDF kommt als n√§chster Schritt. (Button funktioniert)");
});

/* ===================== LAYOUT OFFSET ===================== */
function adjust(){
  const rect = topbar.getBoundingClientRect();
  const top = Math.ceil(rect.height) + 6;
  document.body.style.paddingTop = top + "px";
  document.documentElement.style.setProperty("--topOffset", top + "px");
}

const rowsWrap = document.getElementById("rowsWrap");
const headerInner = document.getElementById("gridHeaderInner");
rowsWrap.addEventListener("scroll", ()=>{
  // Move header opposite to scrollLeft so columns stay aligned
  headerInner.style.transform = `translateX(${-rowsWrap.scrollLeft}px)`;
}, {passive:true});

window.addEventListener("resize", adjust);
window.addEventListener("orientationchange", ()=>setTimeout(adjust, 80));

/* Init */
loadLocal();
loadSalesLocal();
render();
adjust();
// iOS: nach Layout/Fonts nochmal nachziehen
setTimeout(adjust, 0);
setTimeout(adjust, 250);
</script>


<!-- Verkauf Popup -->
<div id="saleModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000">
  <div class="box">
    <h3 id="saleTitle" style="margin:0 0 6px;font-size:12px">Verkauf</h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
      <div>
        <label>Verkaufsnummer</label>
        <input id="sNumber" autocomplete="off">
      </div>
      <div>
        <label>Datum</label>
        <input id="sDate" type="date">
      </div>
    </div>

    <label>Wo verkauft</label>
    <input id="sPlace" placeholder="z.B. Ebay, Kleinanzeigen, Laden ‚Ä¶" autocomplete="off">

    <div class="row2" style="margin-top:2px">
      <div>
        <label>Menge</label>
        <input id="sQty" type="number" inputmode="numeric" value="1">
      </div>
      <div>
        <label>Preis (gesamt)</label>
        <input id="sPrice" type="number" inputmode="decimal" value="0">
      </div>
    </div>

    <label>Versandkosten</label>
    <input id="sShip" type="number" inputmode="decimal" value="0">

    <div class="hint" id="sHint" style="margin-top:8px"></div>

    <div class="btnRow">
      <button id="sSave">Speichern</button>
      <button id="sCancel">Abbrechen</button>
    </div>
  </div>
</div>


<!-- Verk√§ufe (√úbersicht) -->
<div id="salesModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000">
  <div class="box" style="max-width:720px">
    <h3 style="margin:0 0 6px;font-size:12px">Verk√§ufe</h3>
    <div style="overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid #333;border-radius:10px;padding:6px;max-height:55vh">
      <div style="display:grid;grid-template-columns:78px 86px 90px 1fr 52px 70px 120px;gap:4px;font-size:9px;color:#ddd;border-bottom:1px solid #333;padding-bottom:4px;white-space:nowrap">
        <div>Nr</div><div>Datum</div><div>V-Nr</div><div>Artikel</div><div>Menge</div><div>Preis</div><div>Ort</div>
      </div>
      <div id="salesList" style="margin-top:4px"></div>
    </div>
    <div class="btnRow">
      <button id="salesClose">Schlie√üen</button>
    </div>
  </div>
</div>

</body>
</html>
