<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lager V22 Final</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --input-bg: #2d2d2d;
            --primary: #3b82f6; --text: #e5e7eb; --text-muted: #9ca3af;
            --border: #333; --danger: #ef4444; --success: #10b981; --profit: #eab308;
            color-scheme: dark; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }

        /* HEADER (Design V19/20) */
        .app-header { background: rgba(30,30,30,0.98); backdrop-filter: blur(10px); padding: 8px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 800; }
        .header-actions { display: flex; gap: 12px; }
        
        /* Fix f√ºr Einstellbutton */
        .icon-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 5px; z-index: 1001; position: relative; }

        .search-container { position: relative; width: 100%; }
        .search-input { width: 100%; height: 32px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; padding: 0 30px; color: white; box-sizing: border-box; }
        .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* STATS */
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; margin-top: 10px; padding-top: 8px; border-top: 1px solid #333; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.6rem; color: #777; display: block; }
        .stat-val { font-size: 0.75rem; font-weight: bold; display: block; }
        .c-blue { color: #60a5fa; } .c-green { color: var(--success); } .c-gold { color: var(--profit); }

        /* LISTE */
        .item-row { background: var(--card); border-bottom: 1px solid #252525; padding: 10px; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
        .qty-badge { font-weight: bold; color: var(--primary); min-width: 25px; }
        .item-title { font-weight: 600; font-size: 0.85rem; display: block; }
        .item-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .btn-mini { background: #2d2d2d; border: 1px solid #444; color: #ddd; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        /* GRUPPIERTER VERLAUF */
        .sale-group { background: #1a1a1a; margin: 10px; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .group-header { background: #2a2a2a; padding: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; font-size: 0.7rem; color: var(--profit); font-family: monospace; }
        .group-item { padding: 8px; border-bottom: 1px dotted #333; display: flex; justify-content: space-between; align-items: center; }
        .group-footer { padding: 8px; background: #222; display: flex; justify-content: space-between; align-items: center; }
        .btn-icon-sm { background: #333; border: 1px solid #444; color: #ccc; padding: 4px; border-radius: 4px; cursor: pointer; }
        .btn-storno { color: #ff8888; border-color: #552222; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card); width: 95%; max-width: 500px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 12px; font-weight: bold; text-align: center; border-bottom: 1px solid #333; }
        .modal-body { padding: 15px; }
        .modal-footer { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #1a1a1a; }

        .basket-item { background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        #addItemSearch { width: 100%; padding: 10px; background: #111; border: 1px dashed #444; color: #888; border-radius: 8px; margin: 10px 0; outline: none; }
        
        input, select, textarea { width: 100%; height: 38px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; padding: 0 10px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        label { font-size: 0.7rem; color: #888; margin-bottom: 4px; display: block; }
        .btn-full { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-gray { background: #444; color: white; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 500; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-top">
            <h1>üì¶ MEIN LAGER</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="openHistory()">üïí</button>
                <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="Suche..." onkeyup="renderList()">
        </div>
        <div class="stats-bar">
            <div class="stat-box"><span class="stat-label">Menge</span><span id="statCount" class="stat-val">0</span></div>
            <div class="stat-box"><span class="stat-label">Wert</span><span id="statValue" class="stat-val c-blue">0 ‚Ç¨</span></div>
            <div class="stat-box"><span class="stat-label">Umsatz</span><span id="statRevenue" class="stat-val c-green">0 ‚Ç¨</span></div>
            <div class="stat-box"><span class="stat-label">Gewinn</span><span id="statProfit" class="stat-val c-gold">0 ‚Ç¨</span></div>
        </div>
    </div>

    <div id="itemList"></div>
    <button class="fab" onclick="openEditModal()">+</button>

    <div id="modalEdit" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header" id="modalTitle">Artikel bearbeiten</div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <label>Art.-Nr.</label><input type="text" id="inpArtnr">
                <label>Name</label><input type="text" id="inpName">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Menge</label><input type="number" id="inpMenge"></div>
                    <div><label>EK-Preis (‚Ç¨)</label><input type="number" step="0.01" id="inpPreis"></div>
                </div>
                <label>Bild</label>
                <input type="file" onchange="handleImage(this, 'inpBild', 'imgPreview')">
                <input type="hidden" id="inpBild">
                <img id="imgPreview" style="width:100%; display:none; border-radius:8px; margin-top:10px;">
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()">Abbrechen</button>
                <button class="btn-full btn-blue" onclick="saveItem()">Speichern</button>
                <button class="btn-full" style="background:#300; color:#f88; grid-column:1/-1" onclick="deleteItem()">L√∂schen</button>
            </div>
        </div>
    </div>

    <div id="modalSell" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Verkauf erfassen</div>
            <div class="modal-body">
                <label>Rechnungsnummer</label>
                <input type="text" id="sellInvoiceNr">
                <div id="sellBasketList"></div>
                <input type="text" id="addItemSearch" placeholder="+ Weiteren Artikel suchen..." onkeyup="searchForItem(this)">
                <div id="searchDropdown" style="display:none; background:#333; border-radius:8px; max-height:150px; overflow-y:auto; margin-bottom:10px; border:1px solid #444;"></div>
                
                <label>Versandkosten (‚Ç¨)</label>
                <input type="number" id="sellShipping" value="0" oninput="calcBasketTotal()">
                <label>Gesamterl√∂s</label>
                <input type="text" id="sellTotal" disabled style="color:var(--success); font-weight:bold;">
                
                <label>Rechnungsbild</label>
                <input type="file" onchange="handleImage(this, 'sellBild', 'sellImgPreview')">
                <input type="hidden" id="sellBild">
                <img id="sellImgPreview" style="width:100%; display:none; border-radius:8px; margin-top:10px;">
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()">Abbrechen</button>
                <button class="btn-full btn-blue" onclick="performSell()">Verkaufen</button>
            </div>
        </div>
    </div>

    <div id="modalHistory" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Verk√§ufe (Gruppiert)</div>
            <div id="historyList" style="padding-bottom:20px;"></div>
            <div class="modal-footer">
                <button class="btn-full btn-gray" onclick="closeModals()" style="grid-column:1/-1">Schlie√üen</button>
            </div>
        </div>
    </div>

    <div id="modalSettings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">Einstellungen & Backup</div>
            <div class="modal-body">
                <button class="btn-full btn-blue" onclick="exportBackup()" style="margin-bottom:20px;">Backup exportieren</button>
                <label>Backup importieren</label>
                <input type="file" accept=".json" onchange="importBackup(this)">
            </div>
            <div class="modal-footer"><button class="btn-full btn-gray" onclick="closeModals()" style="grid-column:1/-1">Schlie√üen</button></div>
        </div>
    </div>

    <script>
        const DB_NAME = 'LagerDB_V1';
        let db, inventory = [], salesLog = [];

        async function init() {
            db = await new Promise(r => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => {
                    const d = e.target.result;
                    d.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                    d.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                };
                req.onsuccess = e => r(e.target.result);
            });
            await loadData();
            renderList();
        }

        async function loadData() {
            inventory = await dbOp('inventory', 'getAll');
            salesLog = await dbOp('sales', 'getAll');
        }

        function dbOp(store, method, data) {
            return new Promise(r => {
                const tx = db.transaction(store, 'readwrite');
                const s = tx.objectStore(store);
                const req = data ? s[method](data) : s[method]();
                req.onsuccess = () => r(req.result);
            });
        }

        function renderList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('itemList');
            list.innerHTML = '';
            let tQty=0, tVal=0, tRev=0, tProf=0;

            [...inventory].reverse().forEach(i => {
                if(i.name.toLowerCase().includes(term) || i.artnr.toLowerCase().includes(term)) {
                    tQty += i.menge; tVal += (i.preis * i.menge);
                    const div = document.createElement('div');
                    div.className = 'item-row';
                    div.innerHTML = `
                        <div class="qty-badge">${i.menge}x</div>
                        <div onclick="openEditModal(${i.id})" style="flex-grow:1">
                            <span class="item-title">${i.name}</span>
                            <span class="item-meta">#${i.artnr} | ${i.preis.toFixed(2)}‚Ç¨</span>
                        </div>
                        <button class="btn-mini" onclick="openSellModal(${i.id})">Verkauf</button>
                    `;
                    list.appendChild(div);
                }
            });

            salesLog.forEach(s => {
                tRev += s.total;
                tProf += (s.total - (s.shipping || 0) - (s.buyPrice * s.qty));
            });

            document.getElementById('statCount').innerText = tQty;
            document.getElementById('statValue').innerText = tVal.toFixed(2) + "‚Ç¨";
            document.getElementById('statRevenue').innerText = tRev.toFixed(2) + "‚Ç¨";
            document.getElementById('statProfit').innerText = tProf.toFixed(2) + "‚Ç¨";
        }

        // --- VERLAUF ---
        function openHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            document.getElementById('modalHistory').style.display = 'flex';
            
            const groups = {};
            salesLog.forEach(s => {
                if(!groups[s.invoiceNr]) groups[s.invoiceNr] = { items:[], total:0, date:s.date };
                groups[s.invoiceNr].items.push(s);
                groups[s.invoiceNr].total += s.total;
            });

            Object.keys(groups).reverse().forEach(inv => {
                const g = groups[inv];
                const div = document.createElement('div');
                div.className = 'sale-group';
                let itemsHtml = g.items.map(it => `
                    <div class="group-item">
                        <span style="font-size:0.75rem;">${it.name} (${it.qty}x)</span>
                        <button class="btn-icon-sm btn-storno" onclick="restoreSale(${it.id})" title="Stornieren & Bestand zur√ºck">‚Ü©Ô∏è</button>
                    </div>
                `).join('');
                div.innerHTML = `
                    <div class="group-header"><span>RE: ${inv}</span><span>${g.date}</span></div>
                    ${itemsHtml}
                    <div class="group-footer">
                        <span style="font-weight:bold; color:var(--success)">Total: ${g.total.toFixed(2)}‚Ç¨</span>
                        <button class="btn-icon-sm" onclick="deleteInvoiceOnly('${inv}')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function restoreSale(id) {
            const s = salesLog.find(x => x.id === id);
            if(confirm(`Verkauf von ${s.name} stornieren und Artikel zur√ºck ins Lager?`)) {
                let it = inventory.find(x => x.artnr === s.artnr);
                if(it) { it.menge += s.qty; await dbOp('inventory', 'put', it); }
                else { await dbOp('inventory', 'add', { artnr:s.artnr, name:s.name, menge:s.qty, preis:s.buyPrice }); }
                await dbOp('sales', 'delete', id);
                await loadData(); openHistory(); renderList();
            }
        }

        async function deleteInvoiceOnly(inv) {
            if(confirm("Diese Rechnung komplett aus der Liste l√∂schen? (Bestand bleibt gleich)")) {
                const toDel = salesLog.filter(s => s.invoiceNr === inv);
                for(let s of toDel) await dbOp('sales', 'delete', s.id);
                await loadData(); openHistory(); renderList();
            }
        }

        // --- VERKAUF ---
        let basket = [];
        function openSellModal(id) {
            const it = inventory.find(x => x.id === id);
            basket = [{ id: it.id, name: it.name, artnr: it.artnr, stock: it.menge, qty: 1, price: it.preis }];
            document.getElementById('sellInvoiceNr').value = "RE-" + Date.now().toString().slice(-5);
            document.getElementById('sellShipping').value = 0;
            document.getElementById('sellBild').value = it.bild || "";
            document.getElementById('sellImgPreview').src = it.bild || "";
            document.getElementById('sellImgPreview').style.display = it.bild ? 'block' : 'none';
            renderBasket();
            document.getElementById('modalSell').style.display = 'flex';
        }

        function renderBasket() {
            const list = document.getElementById('sellBasketList');
            list.innerHTML = '';
            basket.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'basket-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                        <b>${p.name}</b> <span onclick="basket.splice(${idx},1);renderBasket()" style="color:red">‚úï</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="number" value="${p.qty}" onchange="basket[${idx}].qty=parseInt(this.value);calcBasketTotal()">
                        <input type="number" value="${p.price}" onchange="basket[${idx}].price=parseFloat(this.value);calcBasketTotal()">
                    </div>
                `;
                list.appendChild(div);
            });
            calcBasketTotal();
        }

        function calcBasketTotal() {
            let sum = basket.reduce((a, b) => a + b.price, 0);
            sum += parseFloat(document.getElementById('sellShipping').value || 0);
            document.getElementById('sellTotal').value = sum.toFixed(2) + " ‚Ç¨";
        }

        function searchForItem(inp) {
            const term = inp.value.toLowerCase();
            const drop = document.getElementById('searchDropdown');
            drop.innerHTML = '';
            if(term.length < 2) { drop.style.display='none'; return; }
            inventory.filter(i => i.name.toLowerCase().includes(term) && i.menge > 0).forEach(hit => {
                const d = document.createElement('div');
                d.style.padding = '10px'; d.style.borderBottom = '1px solid #444'; d.innerText = hit.name;
                d.onclick = () => {
                    basket.push({ id: hit.id, name: hit.name, artnr: hit.artnr, stock: hit.menge, qty: 1, price: hit.preis });
                    if(!document.getElementById('sellBild').value && hit.bild) {
                        document.getElementById('sellBild').value = hit.bild;
                        document.getElementById('sellImgPreview').src = hit.bild;
                        document.getElementById('sellImgPreview').style.display = 'block';
                    }
                    inp.value = ''; drop.style.display = 'none'; renderBasket();
                };
                drop.appendChild(d);
            });
            drop.style.display = 'block';
        }

        async function performSell() {
            const inv = document.getElementById('sellInvoiceNr').value;
            const ship = parseFloat(document.getElementById('sellShipping').value || 0);
            const date = new Date().toLocaleDateString();
            const img = document.getElementById('sellBild').value;

            for(let i=0; i < basket.length; i++) {
                const p = basket[i];
                const it = inventory.find(x => x.id === p.id);
                it.menge -= p.qty;
                await dbOp('inventory', 'put', it);
                await dbOp('sales', 'add', {
                    name: p.name, artnr: p.artnr, date: date, buyPrice: it.preis,
                    qty: p.qty, shipping: (i===0 ? ship : 0), total: p.price + (i===0 ? ship : 0),
                    invoiceNr: inv, invoiceImg: img
                });
            }
            await loadData(); closeModals(); renderList();
        }

        // --- EDIT ---
        function openEditModal(id = null) {
            if(!id) {
                document.getElementById('editId').value = '';
                document.getElementById('inpArtnr').value = "ART-" + Date.now().toString().slice(-4);
                document.getElementById('inpName').value = '';
                document.getElementById('inpMenge').value = 1;
                document.getElementById('inpPreis').value = '';
                document.getElementById('inpBild').value = '';
                document.getElementById('imgPreview').style.display = 'none';
            } else {
                const it = inventory.find(x => x.id === id);
                document.getElementById('editId').value = it.id;
                document.getElementById('inpArtnr').value = it.artnr;
                document.getElementById('inpName').value = it.name;
                document.getElementById('inpMenge').value = it.menge;
                document.getElementById('inpPreis').value = it.preis;
                document.getElementById('inpBild').value = it.bild || '';
                if(it.bild) { document.getElementById('imgPreview').src = it.bild; document.getElementById('imgPreview').style.display='block'; }
            }
            document.getElementById('modalEdit').style.display = 'flex';
        }

        async function saveItem() {
            const id = document.getElementById('editId').value;
            const obj = {
                name: document.getElementById('inpName').value,
                artnr: document.getElementById('inpArtnr').value,
                menge: parseInt(document.getElementById('inpMenge').value),
                preis: parseFloat(document.getElementById('inpPreis').value),
                bild: document.getElementById('inpBild').value
            };
            if(id) { obj.id = parseInt(id); await dbOp('inventory', 'put', obj); }
            else { await dbOp('inventory', 'add', obj); }
            await loadData(); closeModals(); renderList();
        }

        async function deleteItem() {
            const id = parseInt(document.getElementById('editId').value);
            if(id && confirm("Artikel l√∂schen?")) {
                await dbOp('inventory', 'delete', id);
                await loadData(); closeModals(); renderList();
            }
        }

        // --- HELPER ---
        function openSettings() { document.getElementById('modalSettings').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function handleImage(input, targetId, previewId) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(targetId).value = e.target.result;
                document.getElementById(previewId).src = e.target.result;
                document.getElementById(previewId).style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
        function exportBackup() {
            const blob = new Blob([JSON.stringify({artikel:inventory, sales:salesLog})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lager_backup.json'; a.click();
        }
        function importBackup(inp) {
            const reader = new FileReader();
            reader.onload = async e => {
                const data = JSON.parse(e.target.result);
                await dbOp('inventory', 'clear'); await dbOp('sales', 'clear');
                for(let i of data.artikel) { delete i.id; await dbOp('inventory', 'add', i); }
                for(let s of data.sales) { delete s.id; await dbOp('sales', 'add', s); }
                location.reload();
            };
            reader.readAsText(inp.files[0]);
        }

        init();
    </script>
</body>
</html>
