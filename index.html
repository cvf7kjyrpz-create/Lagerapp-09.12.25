<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Lager App</title>

<style>
body{margin:0;background:#000;color:white;font-family:Arial,sans-serif;overflow:hidden;overscroll-behavior:none;}
#topbar{position:fixed;top:0;left:0;right:0;padding:15px;background:#000;z-index:5000;border-bottom:2px solid #333;}
#counterWrapper{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.counter-box{padding:10px;border:1px solid #444;border-radius:10px;background:#000;}
.counter-title{font-size:11px;color:#bbb;}
.counter-value{font-size:18px;font-weight:bold;}
#searchRow{margin-top:10px;}
#search{width:100%;padding:10px;border-radius:8px;background:#111;border:1px solid #444;color:white;box-sizing:border-box;}
#buttonRow{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
#buttonRow button{flex:1;padding:6px 4px;font-size:10px;color:#bbb;border-radius:8px;background:#000;border:1px solid #444;font-weight:bold;height:32px}

#tableContainer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  overflow-y:auto;
  overflow-x:auto;
  overscroll-behavior:none;   /* verhindert Gummiband komplett */
  touch-action:pan-x pan-y;  /* verhindert diagonales Scrollen */
  background:#000;
  z-index:100;
  padding-bottom:calc(env(safe-area-inset-bottom) + 16px); /* ‚úÖ letzter Artikel nicht verdeckt */
}

table{width:100%;border-collapse:collapse;}
th{background:#111;position:sticky;top:0;z-index:200;padding:6px;color:#bbb;font-size:9px;white-space:nowrap;}
td{padding:4px;font-size:9px;border-bottom:1px solid #222;white-space:nowrap;}
.marked{background:#222;}
.iconCell span{cursor:pointer;margin-right:8px;}
.iconCell span.delete{margin-left:18px;}
input.miniQty{width:42px;background:#111;color:white;border:1px solid #444;border-radius:5px;text-align:center;}

#popup,#viewPopup,#salePopup,#salesHistoryPopup{
  z-index:10000;
position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#111;padding:16px;border:2px solid #444;border-radius:12px;
width:360px;max-width:92vw;overflow:hidden;display:none;z-index:9999;
}
.popup-row{margin-bottom:8px;text-align:left;}
.popup-row input,.popup-row textarea,.popup-row select{
box-sizing:border-box;
margin:0 auto;
display:block;margin:0 auto;}
.popup-row label{font-size:12px;color:#bbb;display:block;margin-bottom:3px;text-align:center;}
.popup-row input,.popup-row textarea,.popup-row select{
box-sizing:border-box;
margin:0 auto;

width:100%;padding:8px;border-radius:8px;
border:1px solid #444;background:#1a1a1a;color:white;
}
#popupButtons,#saleButtons{display:flex;gap:8px;margin-top:10px;}
#popupButtons button,#saleButtons button{flex:1;padding:7px;border-radius:8px;background:#000;border:1px solid #444;color:#fff;font-weight:bold;font-size:11px;height:34px}
img.preview{max-width:100%;border-radius:8px;margin-top:10px;}
#salesHistoryPopup h3{margin-top:0;font-size:16px;}
#salesHistoryPopup table{width:100%;border-collapse:collapse;font-size:11px;}
#salesHistoryPopup th,#salesHistoryPopup td{border:1px solid #444;padding:4px;white-space:nowrap;}

.selectedRow{
  background:#0b2a4a !important;
}
#btnSaleSend{display:none;}
</style>


<style>
.tr-zero-stock{
  background:#3a0000 !important;
}
</style>


<style>
#salesHistoryPopup{
  overflow-x: auto !important;
}
#salesHistoryPopup table{
  min-width: 900px !important;
}
</style>

</head>

<body>

<div id="topbar">
  <div id="counterWrapper">
    <div class="counter-box">
      <div class="counter-title">Artikel im Bestand</div>
      <div id="countArtikel" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Gegenst√§nde insgesamt</div>
      <div id="countMenge" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Warenwert aktuell (‚Ç¨)</div>
      <div id="countWert" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Warenwert gesamt (‚Ç¨)</div>
      <div id="countWertTotal" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Umsatz Jahr (‚Ç¨)</div>
      <div id="countUmsatzJahr" class="counter-value">0</div>
    </div>
    <div class="counter-box">
      <div class="counter-title">Gewinn gesamt (‚Ç¨)</div>
      <div id="countGewinn" class="counter-value">0</div>
    </div>
  </div>

  <div id="searchRow"><input id="search" placeholder="Suchen ‚Ä¶"></div>

  <div id="buttonRow">
    <button id="btnAdd">+ Artikel</button>
    <button id="btnExport">Sichern</button>
    <button id="btnImport">Laden</button>
    <button id="btnPDF">PDF</button>
    <button id="btnSales">Verk√§ufe</button>
  </div>
</div>

<div id="tableContainer">
<table>
<thead>
<tr>
  <th>*</th>
  <th>Nr</th>
  <th>Name</th>
  <th>Zustand</th>
  <th>Menge</th>
  <th>Gr√∂√üe</th>
  <th>Einz.</th>
  <th>Gesamt</th>
  <th>Ort</th>
  <th>Datum</th>
  <th>Aktionen</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<!-- Artikel-Popup -->
<div id="popup">
  <div class="popup-row"><label>Artikelnummer</label><input id="p_artnr"></div>
  <div class="popup-row"><label>Name</label><input id="p_name"></div>
  <div class="popup-row"><label>Menge</label><input type="number" id="p_menge" value="1"></div>
  <div class="popup-row"><label>Gr√∂√üe</label><input id="p_groesse"></div>
  <div class="popup-row"><label>Preis (Einkauf, pro St√ºck)</label><input type="number" id="p_preis" step="0.01"></div>
  <div class="popup-row"><label>Ort</label><input id="p_ort"></div>
  <div class="popup-row"><label>Datum</label><input type="date" id="p_datum"></div>
  <div class="popup-row">
    <label>Zustand</label>
    <select id="p_zustand">
      <option value="Neu">Neu</option>
      <option value="Gebraucht">Gebraucht</option>
    </select>
  </div>
  <div class="popup-row"><label>Bild</label><input type="file" id="p_bild" accept="image/*" capture="environment"></div>
  <div class="popup-row"><label>Notiz</label><textarea id="p_notiz"></textarea></div>
  <div id="popupButtons">
    <button id="btnSave">Speichern</button>
    <button id="btnCancel">Abbrechen</button>
  </div>
</div>

<!-- Bild / Notiz Anzeige -->
<div id="viewPopup"></div>

<!-- Verkaufs-Popup -->
<div id="salePopup">
  <div class="popup-row"><label>Rechnungsnummer</label><input id="s_rechnung"></div>
  <div class="popup-row"><label>Verkaufte Menge</label><input type="number" id="s_menge" min="1"></div>
  <div class="popup-row"><label>Verkaufspreis pro St√ºck (‚Ç¨)</label><input type="number" id="s_preis" step="0.01"></div>
  <div class="popup-row"><label>Versand vom Kunden (‚Ç¨)</label><input type="number" id="s_versandKunde" step="0.01"></div>
  <div class="popup-row"><label>Eigene Versandkosten (‚Ç¨)</label><input type="number" id="s_versandKosten" step="0.01"></div>
  <div class="popup-row"><label>Verkaufsdatum</label><input type="date" id="s_datum"></div>
  <div id="saleButtons">
    <button id="btnSaleSend">An Rechnung senden</button>
    <button id="btnSaleOk">Verkaufen</button>
    <button id="btnSaleCancel">Abbrechen</button>
  </div>
</div>

<!-- Verkaufs-Historie -->
<div id="salesHistoryPopup">
  <h3>Verk√§ufe</h3>
  <input id="salesSearch" placeholder="Suche..." style="width:100%;margin-bottom:8px;">
  <table>
    <thead>
      <tr>
        <th>Re-Nr</th>
        <th>Datum</th>
        <th>Nr</th>
        <th>Name</th>
        <th>Menge</th>
        <th>Umsatz</th>
        <th>Gewinn</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="salesBody"></tbody>
  </table>
  <div style="margin-top:10px;text-align:right;">
    <button onclick="closeSalesHistory()">Schlie√üen</button>
  </div>
</div>

<script>

function resetFileInput(input){
  const newInput = input.cloneNode();
  input.parentNode.replaceChild(newInput, input);
  return newInput;
}

let artikel = JSON.parse(localStorage.getItem("lagerData") || "[]");
let sales   = JSON.parse(localStorage.getItem("lagerSales") || "[]");
let editIndex = -1;
let currentSaleIndex = -1;
let selectedRowIndex = -1;
let editSaleIndex = -1;

/* ===== Artikelnummern-Logik ===== */

function initArtNrCounter(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;

  if (localStorage.getItem(key) !== null) return;

  let max = -1;
  artikel.forEach(a=>{
    if(!a.artnr) return;
    const m = a.artnr.match(/^(\d{3})-(\d{4})$/);
    if(m && Number(m[2]) === jahr){
      max = Math.max(max, Number(m[1]));
    }
  });

  localStorage.setItem(key, max);
}

function previewNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  const val  = Number(localStorage.getItem(key) || -1) + 1;
  return String(val).padStart(3,"0") + "-" + jahr;
}

function commitNextArtNr(){
  const jahr = new Date().getFullYear();
  const key  = "artnrCounter_" + jahr;
  let counter = Number(localStorage.getItem(key) || -1) + 1;
  localStorage.setItem(key, counter);
  return String(counter).padStart(3,"0") + "-" + jahr;
}

initArtNrCounter();

/* ===== Layout: Tabelle direkt unter Header ===== */

function adjustTableTop(){
  const header = document.getElementById("topbar");
  const tableC = document.getElementById("tableContainer");
  tableC.style.top = header.offsetHeight + "px";
}
window.addEventListener("load", adjustTableTop);
window.addEventListener("resize", adjustTableTop);

/* ===== Datum formatieren (TT-MM-JJJJ) ===== */

function formatDate(d){
  if(!d) return "";
  const [y,m,dd] = d.split("-");
  return `${dd}-${m}-${y}`;
}

/* ===== Auto-Backup (wie "Sichern") ===== */

function autoBackup(reason){
  const data = { artikel, sales };
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const a    = document.createElement("a");
  a.href     = URL.createObjectURL(blob);
  a.download = "lager_backup.json";  // immer gleicher Dateiname ‚Üí iPhone fragt nach √úberschreiben
  a.click();
}

/* ===== Rendern Lager-Tabelle ===== */

function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  artikel.forEach((a,i)=>{
    if(!a) return; // alle Artikel anzeigen, auch wenn Bestand 0 ist

    const tr = document.createElement("tr");
    tr.onclick = () => selectRow(i);
    if(a.markiert) tr.classList.add("marked");
    if(i === selectedRowIndex) tr.classList.add("selectedRow");

    if(a.menge === 0){
      tr.classList.add("tr-zero-stock");
    }

    const gesamt = (a.preis * a.menge).toFixed(2);

    tr.innerHTML = `
      <td onclick="toggleMark(${i})">${a.markiert ? "‚≠ê" : "‚òÜ"}</td>
      <td>${a.artnr || ""}</td>
      <td>${a.name || ""}</td>
      <td>${a.zustand || ""}</td>
      <td><input class="miniQty" type="number" value="${a.menge}" onchange="updateQty(${i},this.value)"></td>
      <td>${a.groesse || ""}</td>
      <td>${isNaN(a.preis) ? "" : a.preis.toFixed(2)}</td>
      <td>${isNaN(a.preis) ? "" : gesamt}</td>
      <td>${a.ort || ""}</td>
      <td>${a.datum ? formatDate(a.datum) : ""}</td>
      <td class="iconCell">
        <span onclick="viewImg(${i})">üì∑</span>
        <span onclick="viewNote(${i})">üìù</span>
        <span onclick="editArtikel(${i})">‚úèÔ∏è</span>
        <span onclick="sellArtikel(${i})">üõí</span>
        <span class="delete" onclick="del(${i})">üóë</span>
      </td>
    `;

    const cam = tr.querySelector(".iconCell span:nth-child(1)");
    if(cam){
      if(!a.bild){
        cam.style.opacity = "0.3";
        cam.style.pointerEvents = "none";
      } else {
        cam.style.opacity = "1";
        cam.style.pointerEvents = "auto";
      }
    }

    const note = tr.querySelector(".iconCell span:nth-child(2)");
    if(note){
      if(!a.notiz){
        note.style.opacity = "0.3";
        note.style.pointerEvents = "none";
      } else {
        note.style.opacity = "1";
        note.style.pointerEvents = "auto";
      }
    }

    tbody.appendChild(tr);
  });

  updateCounters();
  adjustTableTop();
}

/* ===== Z√§hler ===== */

function updateCounters(){
  let m = 0;
  let w = 0;
  artikel.forEach(a=>{
    m += a.menge || 0;
    w += (a.menge || 0) * (a.preis || 0);
  });
  document.getElementById("countArtikel").textContent   = artikel.filter(a=>a && a.menge>0).length;
  document.getElementById("countMenge").textContent     = m;
  document.getElementById("countWert").textContent      = w.toFixed(2);
  document.getElementById("countWertTotal").textContent = w.toFixed(2);

  // Umsatz & Gewinn aus Verk√§ufen
  let umsatzGes = 0;
  let gewinnGes = 0;
  let umsatzJahr = 0;
  const currentYear = new Date().getFullYear();

  sales.forEach(s=>{
    const u = s.umsatz || 0;
    const g = s.gewinn || 0;
    umsatzGes += u;
    gewinnGes += g;
    if(s.datum){
      const year = parseInt(s.datum.slice(0,4),10);
      if(year === currentYear) umsatzJahr += u;
    }
  });

  const umsatzElm = document.getElementById("countUmsatzJahr");
  const gewinnElm = document.getElementById("countGewinn");

  umsatzElm.textContent = umsatzJahr.toFixed(2);
  gewinnElm.textContent = gewinnGes.toFixed(2);

  // Warnfarben f√ºr 25.000-Grenze
  umsatzElm.style.color = "#bbb";
  if(umsatzJahr >= 25000){
    umsatzElm.style.color = "#ff4d4d"; // rot
  }else if(umsatzJahr >= 22000){
    umsatzElm.style.color = "#ffae42"; // orange
  }
}

/* ===== Menge direkt in Tabelle ===== */

function updateQty(i,val){
  autoBackup("menge");
  artikel[i].menge = parseInt(val) || 0;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  renderTable();
  updateCounters();
}

/* ===== Markieren (‚≠ê) ===== */

function toggleMark(i){
  autoBackup("markierung");
  artikel[i].markiert = !artikel[i].markiert;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  renderTable();
  updateCounters();
}

/* ===== Pop-up Logik (Neu + Bearbeiten) ===== */

const btnAdd    = document.getElementById("btnAdd");
const btnSave   = document.getElementById("btnSave");
const btnCancel = document.getElementById("btnCancel");
const popup     = document.getElementById("popup");

btnAdd.onclick = () => {
  editIndex = -1;
  p_artnr.value       = previewNextArtNr(); // Vorschau
  p_name.value        = "";
  p_menge.value       = 1;
  p_groesse.value     = "";
  p_preis.value       = "";
  p_ort.value         = "";
  p_datum.value       = "";
  p_zustand.value     = "Neu";
  p_bild.value        = "";
  p_notiz.value       = "";
  popup.style.display = "block";
};

btnCancel.onclick = () => {
  popup.style.display = "none";
  editIndex = -1;
};

btnSave.onclick = () => {
  if (editIndex === -1){
    // neuer Artikel
    const nextNr     = commitNextArtNr();
    const artnrInput = p_artnr.value.trim();
    const artnrFinal = artnrInput || nextNr;

    const obj = {
      artnr:  artnrFinal,
      name:   p_name.value.trim(),
      menge: +p_menge.value || 0,
      groesse:p_groesse.value.trim(),
      preis: +p_preis.value || 0,
      ort:    p_ort.value.trim(),
      datum:  p_datum.value,
      zustand:p_zustand.value || "Neu",
      notiz:  p_notiz.value.trim(),
      bild:   "",
      markiert:false
    };

    const file = p_bild.files[0];
    if(file){
      const r = new FileReader();
      r.onload = e => { obj.bild = e.target.result; pushNew(obj); };
      r.readAsDataURL(file);
    } else {
      pushNew(obj);
    }

  } else {
    // Bearbeiten
    const alt = artikel[editIndex];
    const artnrInput = p_artnr.value.trim();
    const obj = {
      artnr:  artnrInput || alt.artnr,
      name:   p_name.value.trim(),
      menge: +p_menge.value || 0,
      groesse:p_groesse.value.trim(),
      preis: +p_preis.value || 0,
      ort:    p_ort.value.trim(),
      datum:  p_datum.value,
      zustand:p_zustand.value || alt.zustand || "Neu",
      notiz:  p_notiz.value.trim(),
      bild:   alt.bild || "",
      markiert: alt.markiert || false
    };

    const file = p_bild.files[0];
    if(file){
      const r = new FileReader();
      r.onload = e => { obj.bild = e.target.result; applyEdit(obj); };
      r.readAsDataURL(file);
    } else {
      applyEdit(obj);
    }
  }
};

function pushNew(obj){
  artikel.push(obj);
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  popup.style.display = "none";
  editIndex = -1;
  renderTable();
  updateCounters();
}

function applyEdit(obj){
  artikel[editIndex] = obj;
  localStorage.setItem("lagerData", JSON.stringify(artikel));
  popup.style.display = "none";
  editIndex = -1;
  renderTable();
  updateCounters();
}

function editArtikel(i){
  editIndex       = i;
  const a         = artikel[i];
  p_artnr.value   = a.artnr || "";
  p_name.value    = a.name || "";
  p_menge.value   = a.menge || 1;
  p_groesse.value = a.groesse || "";
  p_preis.value   = a.preis || 0;
  p_ort.value     = a.ort || "";
  p_datum.value   = a.datum || "";
  p_zustand.value = a.zustand || "Neu";
  p_bild = resetFileInput(p_bild);
  p_notiz.value   = a.notiz || "";
  popup.style.display = "block";
}

/* ===== L√∂schen, Bild, Notiz ===== */

const viewPopup = document.getElementById("viewPopup");

function del(i){
  if(confirm("Wirklich l√∂schen?")){
    autoBackup("l√∂schen");
    artikel.splice(i,1);
    localStorage.setItem("lagerData", JSON.stringify(artikel));
    renderTable();
  updateCounters();
  }
}

function viewImg(i){
  const a = artikel[i];
  viewPopup.innerHTML = a.bild
    ? `<img class="preview" src="${a.bild}"><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`
    : `<div>Kein Bild</div><br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}

function viewNote(i){
  const a = artikel[i];
  viewPopup.innerHTML = `<div>${a.notiz || "Keine Notiz"}</div>
  <br><button onclick="viewPopup.style.display='none'">Schlie√üen</button>`;
  viewPopup.style.display = "block";
}

/* ===== Verkaufen (Teilmenge m√∂glich) ===== */

const salePopup      = document.getElementById("salePopup");
const btnSaleOk      = document.getElementById("btnSaleOk");
const btnSaleCancel  = document.getElementById("btnSaleCancel");
const s_menge        = document.getElementById("s_menge");
const s_preis        = document.getElementById("s_preis");
const s_versandKunde = document.getElementById("s_versandKunde");
const s_versandKosten= document.getElementById("s_versandKosten");
const s_datum        = document.getElementById("s_datum");

const btnSaleSend   = document.getElementById("btnSaleSend");
const s_rechnung    = document.getElementById("s_rechnung");

function nextInvoiceNrLager(){
  const key = "invoiceCounter";
  let c = parseInt(localStorage.getItem(key) || "0",10) + 1;
  localStorage.setItem(key, c);
  return String(c).padStart(5,"0");
}


function sellArtikel(i){
  currentSaleIndex = i;
  editSaleIndex    = -1;
  const a = artikel[i];
  s_menge.value        = a.menge || 1;
  s_preis.value        = "";
  s_versandKunde.value = "";
  s_versandKosten.value= "";
  s_datum.value        = new Date().toISOString().slice(0,10);
  s_rechnung.value = nextInvoiceNrLager();
  salePopup.style.display = "block";
}

btnSaleCancel.onclick = () => {
  salePopup.style.display = "none";
  currentSaleIndex = -1;
};

btnSaleOk.onclick = () => {
  const mengeV = parseInt(s_menge.value) || 0;
  const preisV = parseFloat(s_preis.value) || 0;
  const versK  = parseFloat(s_versandKunde.value) || 0;
  const versC  = parseFloat(s_versandKosten.value) || 0;
  const datV   = s_datum.value;
  const rNr    = s_rechnung.value || "";

  if(editSaleIndex >= 0){
    const s = sales[editSaleIndex];
    if(!s) return;

    // Menge im Verkauf nicht √§ndern, Bestand bleibt √ºber Storno steuerbar
    if(mengeV <= 0){
      alert("Menge muss gr√∂√üer 0 sein.");
      return;
    }

    s.verkaufPreis = preisV;
    s.versandKunde = versK;
    s.versandKosten= versC;
    s.datum        = datV;
    s.rechnungsnr  = rNr;

    const umsatzNeu = s.menge * s.verkaufPreis + s.versandKunde;
    const einkaufNeu= s.menge * (s.einkaufPreis || 0);
    s.umsatz = umsatzNeu;
    s.gewinn = umsatzNeu - einkaufNeu - s.versandKosten;

    localStorage.setItem("lagerSales", JSON.stringify(sales));
    salePopup.style.display = "none";
    editSaleIndex = -1;
    currentSaleIndex = -1;

    openSalesHistory();
    updateCounters();
    return;
  }

  if(currentSaleIndex === -1) return;
  autoBackup("verkauf");
  const a = artikel[currentSaleIndex];

  if(mengeV <= 0 || mengeV > a.menge){
    alert("Verkaufte Menge ist ung√ºltig.");
    return;
  }

  const umsatz = mengeV * preisV + versK;
  const einkaufKosten = mengeV * (a.preis || 0);
  const gewinn = umsatz - einkaufKosten - versC;

  const sale = {
    artnr: a.artnr,
    name:  a.name,
    menge: mengeV,
    verkaufPreis: preisV,
    versandKunde: versK,
    versandKosten: versC,
    einkaufPreis: a.preis || 0,
    datum: datV,
    umsatz,
    gewinn,
    rechnungsnr: rNr
  };

  sales.push(sale);
  localStorage.setItem("lagerSales", JSON.stringify(sales));

  // Bestand anpassen
  a.menge -= mengeV;
  if(a.menge < 0) a.menge = 0;
  localStorage.setItem("lagerData", JSON.stringify(artikel));

  salePopup.style.display = "none";
  currentSaleIndex = -1;
  renderTable();
  updateCounters();
  updateCounters();
};

function openSalesHistory(){
  const searchInput = document.getElementById("salesSearch");
  if(searchInput){
    renderSalesList(searchInput.value);
  } else {
    renderSalesList("");
  }
  salesHistoryPopup.style.display = "block";
}

function renderSalesList(filter){
  const tbody = document.getElementById("salesBody");
  if(!tbody) return;
  tbody.innerHTML = "";
  const q = (filter || "").toLowerCase();

  sales.forEach((s,idx)=>{
    const txt = (s.name||"") + " " + (s.artnr||"") + " " + (s.rechnungsnr||"") + " " + (s.datum||"");
    if(q && !txt.toLowerCase().includes(q)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.rechnungsnr || ""}</td>
      <td>${s.datum ? formatDate(s.datum) : ""}</td>
      <td>${s.artnr || ""}</td>
      <td>${s.name || ""}</td>
      <td>${s.menge || 0}</td>
      <td>${(s.umsatz||0).toFixed(2)}</td>
      <td>${(s.gewinn||0).toFixed(2)}</td>
      <td>
        <button onclick="editSale(${idx})">‚úèÔ∏è</button>
        <button onclick="stornoSale(${idx})">‚§¥Ô∏è</button>
        <button onclick="deleteSale(${idx})">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function closeSalesHistory(){
  salesHistoryPopup.style.display = "none";
}

/* Storno: Verkauf r√ºckg√§ngig */
function stornoSale(index){
  const s = sales[index];
  if(!s) return;
  if(!confirm("Verkauf stornieren und Bestand wieder erh√∂hen?")) return;

  autoBackup("storno");

  // passenden Artikel suchen (nach Artikelnummer)
  const art = artikel.find(a => a.artnr === s.artnr);
  if(art){
    art.menge = (art.menge || 0) + (s.menge || 0);
  }else{
    // falls Artikel nicht mehr existiert, neu anlegen als einfacher Datensatz
    artikel.push({
      artnr: s.artnr,
      name: s.name,
      menge: s.menge || 0,
      groesse:"",
      preis: s.einkaufPreis || 0,
      ort:"",
      datum:s.datum || "",
      zustand:"Neu",
      notiz:"Storno automatisch angelegt",
      bild:"",
      markiert:false
    });
  }

  // Verkauf aus Historie entfernen
  sales.splice(index,1);
  localStorage.setItem("lagerSales", JSON.stringify(sales));
  localStorage.setItem("lagerData", JSON.stringify(artikel));

  openSalesHistory(); // neu aufbauen
  renderTable();
  updateCounters();
}

function editSale(index){
  const s = sales[index];
  if(!s) return;

  editSaleIndex    = index;
  currentSaleIndex = -1;

  s_menge.value        = s.menge || 1;
  s_preis.value        = s.verkaufPreis || 0;
  s_versandKunde.value = s.versandKunde || 0;
  s_versandKosten.value= s.versandKosten || 0;
  s_datum.value        = s.datum || new Date().toISOString().slice(0,10);
  s_rechnung.value     = s.rechnungsnr || "";

  // Menge beim Bearbeiten nicht √§nderbar, Bestand bleibt √ºber Storno korrekt
  s_menge.disabled = false;

  salePopup.style.display = "block";
}

function deleteSale(index){
  const s = sales[index];
  if(!s) return;
  if(!confirm("Verkauf endg√ºltig aus der Liste l√∂schen?")) return;

  sales.splice(index,1);
  localStorage.setItem("lagerSales", JSON.stringify(sales));
  openSalesHistory();
  updateCounters();
}

/* ===== Sichern / Laden / PDF / Suche ===== */

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const btnPDF    = document.getElementById("btnPDF");
const searchInp = document.getElementById("search");

btnExport.onclick = () => {
  autoBackup("manuell");
};

btnImport.onclick = () => {
  const inp = document.createElement("input");
  inp.type  = "file";
  inp.accept= "application/json";

  inp.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;

    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);

        if(data.artikel && Array.isArray(data.artikel)){
          artikel = data.artikel;
          sales   = data.sales || [];
        }
        else if(Array.isArray(data)){
          artikel = data;
          sales   = [];
        }
        else{
          alert("Unbekanntes Dateiformat!");
          return;
        }

        localStorage.setItem("lagerData", JSON.stringify(artikel));
        localStorage.setItem("lagerSales", JSON.stringify(sales));

        initArtNrCounter();
        renderTable();
  updateCounters();

        alert("Daten erfolgreich geladen ‚úî");

      }catch{
        alert("Datei konnte nicht gelesen werden!");
      }
    };

    r.readAsText(file);
  };

  inp.click();
};

btnPDF.onclick = () => {
  let w = window.open("","_blank");
  let html = `<table border="1" cellpadding="4">
  <tr><th>Nr</th><th>Name</th><th>Menge</th><th>Notiz</th></tr>`;
  artikel.forEach(a=>{
    if(!a || a.menge <= 0) return;
    html += `<tr><td>${a.artnr||""}</td><td>${a.name||""}</td><td>${a.menge||0}</td><td>${a.notiz||""}</td></tr>`;
  });
  html += `</table>`;
  w.document.write(html);
  w.print();
};

searchInp.oninput = () => {
  const q = searchInp.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
};

/* ===== Start ===== */
renderTable();
  updateCounters();

// ‚úÖ Blau-Markierung: nur visuell, nicht gespeichert
function selectRow(i){
  if(selectedRowIndex === i){
    selectedRowIndex = -1;
  } else {
    selectedRowIndex = i;
  }
  renderTable();
  updateCounters();
}

btnSaleSend.onclick = () => {
  if(currentSaleIndex === -1) return;
  const a = artikel[currentSaleIndex];
  const mengeV = parseInt(s_menge.value) || 0;
  const preisV = parseFloat(s_preis.value) || 0;

  if(mengeV <= 0 || preisV <= 0){
    alert("Bitte Menge und Preis korrekt eingeben.");
    return;
  }

  const pending = {
    name: a.name,
    menge: mengeV,
    preis: preisV
  };

  localStorage.setItem("pendingInvoiceData", JSON.stringify(pending));

  salePopup.style.display = "none";
  
};

</script>






<script>
document.addEventListener("DOMContentLoaded", () => {
  const fileInput = document.getElementById("fileInput");
  if(fileInput){
    fileInput.onchange = e => {
      const file = e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ev => {
        try{
          artikel = JSON.parse(ev.target.result) || [];
          localStorage.setItem("lagerData", JSON.stringify(artikel));
          renderTable();
  updateCounters();
          alert("Datei erfolgreich geladen ‚úÖ");
        }catch(err){
          alert("Datei konnte nicht geladen werden");
        }
      };
      r.readAsText(file);
    };
  }
});
</script>







<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnExport = document.getElementById("btnExport");
  const btnSave   = document.getElementById("btnSave");
  const popup     = document.getElementById("popup");

  if (btnExport) {
    const origExport = btnExport.onclick;
    btnExport.onclick = () => {
      if (popup && popup.style.display === "block" && btnSave) {
        btnSave.click(); // always save article first
      }
      if (typeof origExport === "function") {
        origExport();
      }
    };
  }

  const btnSales = document.getElementById("btnSales");
  if (btnSales && typeof openSalesHistory === "function") {
    btnSales.onclick = () => openSalesHistory();
  }
});
</script>

</body>
</html>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("salesSearch");
  if(searchInput){
    searchInput.oninput = () => renderSalesList(searchInput.value);
  }
});
</script>
