<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Lager App ‚Äì Stabil (Header im Scroll-Container)</title>
<style>
:root{
  --bg:#000;--panel:#0b0b0b;--panel2:#111;--border:#333;--muted:#aaa;--text:#fff;
  --wrapTop:80px;
  --gap:2px;
  --cols: 78px 206px 38px 44px 78px 110px 58px 70px 72px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Arial,system-ui,sans-serif;-webkit-text-size-adjust:100%;overflow:hidden}
button,input,select,textarea{font:inherit;color:inherit}
button{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:5px 6px;font-size:10px}
input,select,textarea{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:4px 6px;color:#fff;width:100%}
textarea{min-height:80px;resize:vertical}

.topbar{
  position:fixed;top:0;left:0;right:0;z-index:5000;
  background:#000;border-bottom:1px solid #333;
  padding:6px 8px;
  padding-top:calc(6px + env(safe-area-inset-top));
}
.actions{display:flex;gap:4px}
.actions button{flex:1}

/* Einziger Scroll-Bereich unter der Topbar */
.tableWrap{
  position:fixed;
  left:0; right:0; bottom:0;
  top: var(--wrapTop);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  padding:0 8px 12px 8px;
  background:#000;
}

/* Header ist im Flow und sticky innerhalb tableWrap => KEIN √úberlappen m√∂glich */
.gridHeader{
  position:sticky;
  top:0;
  z-index:10;
  background:#000;
  border-bottom:1px solid #333;
  padding:2px 0;
  font-size:9px;
}

.gridHeader,.gridRow{
  display:grid;
  grid-template-columns: var(--cols);
  gap: var(--gap);
  align-items:center;
  min-width: calc(44px + 220px + 38px + 44px + 78px + 110px + 58px + 70px + 72px + (8 * var(--gap)));
  white-space:nowrap;
}
.gridRow{
  padding:1px 0;
  border-bottom:1px solid #2a2a2a;
  font-size:9px;
}

.name{font-size:9px;line-height:1.0;overflow:hidden;text-overflow:ellipsis}
.qty{width:34px;text-align:center;padding:1px 3px;font-size:9px;border-radius:7px}
.small{font-size:9px;color:#ddd;overflow:hidden;text-overflow:ellipsis}
.icoBar{display:flex;gap:7px;justify-content:flex-end}
.ico{
  width:20px;height:20px;border:1px solid #333;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  user-select:none;-webkit-tap-highlight-color:transparent;
}
.ico:active{transform:scale(.98)}
.ico.muted{opacity:.35}

/* Modals */
#modal,#saleModal,#salesModal,#viewPhotoModal,#viewNoteModal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000;overflow:hidden
}
.box{
  background:#0b0b0b;border:1px solid #333;border-radius:12px;
  width:92%;max-width:520px;margin:7vh auto;padding:10px;
  max-height:82vh; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
}
.box h3{margin:0 0 6px;font-size:12px}
.box label{font-size:9px;color:#aaa;margin-top:6px;display:block}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.btnRow{display:flex;gap:6px;margin-top:10px;position:sticky;bottom:0;background:#0b0b0b;padding-top:8px}
.btnRow button{flex:1}
.preview{margin-top:8px;border:1px solid #333;border-radius:10px;overflow:hidden;display:none}
.preview img{display:block;width:100%;height:auto;max-height:180px;object-fit:contain}

/* Status */
.gridRow.zero{background:rgba(180,0,0,.18)}
.ico.danger{border-color:#5a2222}
.ico.danger:active{transform:scale(.98)}


/* Trennung Artikelnummer <-> Artikelname */
.cellNo{padding-right:8px;border-right:1px solid #333;overflow:hidden;text-overflow:ellipsis}
.cellName{padding-left:8px}
/* Zeile ausw√§hlen (nur visuell, nicht gespeichert) */
.gridRow.selected{background:rgba(0,110,255,.22)}

</style>
</head>

<body>
<div class="topbar" id="topbar">
  <div class="actions">
    <button id="btnAdd">+ Artikel</button>
    <button id="btnSalesTop">Verk√§ufe</button>
    <button id="btnSave">Sichern</button>
    <button id="btnLoad">Laden</button>
    <button id="btnPDF">PDF</button>
  </div>
</div>

<div class="tableWrap" id="tableWrap">
  <div class="gridHeader" id="gridHeader">
    <div>Nr</div><div>Artikel</div><div>Menge</div><div>EK</div><div>Kaufdatum</div><div>Wo gekauft</div><div>Gr√∂√üe</div><div>Zustand</div><div>Info</div>
  </div>
  <div id="table"></div>
</div>

<!-- Artikel anlegen/bearbeiten -->
<div id="modal">
  <div class="box">
    <h3 id="modalTitle">Artikel anlegen</h3>

    <label>Artikelnummer</label>
    <input id="mArtNo" autocomplete="off" placeholder="z.B. 001-2026">

    <label>Artikelname</label>
    <input id="mName" autocomplete="off">

    <div class="row2">
      <div><label>Menge</label><input id="mQty" type="number" inputmode="numeric" value="1"></div>
      <div><label>EK</label><input id="mEK" type="number" inputmode="decimal" value="0"></div>
    </div>

    <label>Kaufdatum</label>
    <input id="mDate" type="date">

    <label>Wo gekauft</label>
    <input id="mShop" autocomplete="off">

    <div class="row2">
      <div><label>Gr√∂√üe</label><input id="mSize" autocomplete="off"></div>
      <div><label>Zustand</label>
        <select id="mState"><option>Neu</option><option>Neuwertig</option><option>Gebraucht</option></select>
      </div>
    </div>

    <label>Notiz</label>
    <textarea id="mNote" placeholder="Notiz‚Ä¶"></textarea>

    <label style="margin-top:10px">Foto</label>
    <input id="mPhoto" type="file" accept="image/*">
    <div class="preview" id="photoPreview"><img id="photoImg" alt="Foto Vorschau"></div>

    <div class="btnRow">
      <button id="mSave">Speichern</button>
      <button id="mCancel">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Verkauf Popup -->
<div id="saleModal">
  <div class="box">
    <h3 id="saleTitle">Verkauf</h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
      <div><label>Verkaufsnummer</label><input id="sNumber"></div>
      <div><label>Datum</label><input id="sDate" type="date"></div>
    </div>

    <label>Wo verkauft</label>
    <input id="sPlace" placeholder="z.B. Ebay, Kleinanzeigen, Laden ‚Ä¶">

    <div class="row2" style="margin-top:2px">
      <div><label>Menge</label><input id="sQty" type="number" inputmode="numeric" value="1"></div>
      <div><label>Preis (gesamt)</label><input id="sPrice" type="number" inputmode="decimal" value="0"></div>
    </div>

    <label>Versandkosten</label>
    <input id="sShip" type="number" inputmode="decimal" value="0">

    <div class="small" id="sHint" style="margin-top:8px;color:#aaa"></div>

    <div class="btnRow">
      <button id="sSave">Speichern</button>
      <button id="sCancel">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Verk√§ufe √úbersicht -->
<div id="salesModal">
  <div class="box" style="max-width:760px">
    <h3 style="margin:0 0 6px;font-size:12px">Verk√§ufe</h3>
<input id="salesSearch" placeholder="Suchen‚Ä¶" style="width:100%;margin:6px 0 10px 0;font-size:10px;padding:6px 8px;border-radius:10px;border:1px solid #333;background:#111;color:#fff">
    <div style="overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid #333;border-radius:10px;padding:6px;max-height:55vh">
      <div style="display:grid;grid-template-columns:90px 86px 1fr 52px 70px 120px 78px;gap:4px;font-size:9px;color:#ddd;border-bottom:1px solid #333;padding-bottom:4px;white-space:nowrap">
        <div>V-Nr</div><div>Datum</div><div>Artikel</div><div>Menge</div><div>Preis</div><div>Ort</div><div>Aktion</div>
      </div>
      <div id="salesList" style="margin-top:4px"></div>
    </div>
    <div class="btnRow">
      <button id="salesClose">Schlie√üen</button>
    </div>
  </div>
</div>

<script>

const $ = (id)=>document.getElementById(id);

/* ===== Persistenz ===== */
const LS_ITEMS = "lager_items_v3";
const LS_SALES = "lager_sales_v2";
let items = [];
let sales = [];
let editIndex = null;
let saleIndex = null;
let editSaleId = null;
let modalPhotoData = "";
let selectedItemId = null; // nur UI, nicht speichern


function extractItemsFromHTMLText(text){
  // Best-effort: try to find something like "items = [ ... ]" in older HTML versions.
  const candidates = ["items","artikel","inventory","lagerItems","lager_items"];
  for(const key of candidates){
    const idx = text.indexOf(key);
    if(idx === -1) continue;
    const startBracket = text.indexOf("[", idx);
    if(startBracket === -1) continue;
    // bracket matching
    let depth = 0;
    for(let i=startBracket;i<text.length;i++){
      const ch = text[i];
      if(ch === "[") depth++;
      else if(ch === "]"){
        depth--;
        if(depth === 0){
          const snippet = text.slice(startBracket, i+1);
          try{
            const parsed = JSON.parse(snippet);
            if(Array.isArray(parsed)) return parsed;
          }catch(e){
            // ignore and continue
          }
          break;
        }
      }
    }
  }
  return null;
}

function extractItems(parsed){
  if(Array.isArray(parsed)) return parsed;
  if(parsed && typeof parsed === "object"){
    const keys = ["items","artikel","data","inventory","lager","produkte","products"];
    for(const k of keys){ if(Array.isArray(parsed[k])) return parsed[k]; }
    for(const k of Object.keys(parsed)){
      const v = parsed[k];
      if(v && typeof v === "object"){
        for(const k2 of ["items","artikel","data","inventory"]){
          if(Array.isArray(v[k2])) return v[k2];
        }
      }
    }
  }
  return null;
}

function normalizeItems(arr){
  return arr.map(x=>({
    id: String(x.id || x._id || x.uuid || (crypto.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)))) ,
    name: String(x.name ?? x.artikel ?? ""),
    qty: Number(x.qty ?? x.menge ?? 0),
    ek: Number(x.ek ?? x.einkauf ?? x.preis ?? 0),
    date: String(x.date ?? x.kaufdatum ?? x.datum ?? ""),
    shop: String(x.shop ?? x.wo ?? x.ort ?? ""),
    size: String(x.size ?? x.groesse ?? ""),
    state: String(x.state ?? x.zustand ?? "Neu"),
    note: String(x.note ?? x.notiz ?? ""),
    photo: String(x.photo ?? x.foto ?? x.bild ?? ""),
    artNo: String(x.artNo ?? x.nr ?? x.artikelnummer ?? x.artikelNr ?? x.artnr ?? x.artikel_nr ?? x.articleNo ?? x.article_nr ?? x.articleNumber ?? "")
  }));
}

function saveLocal(){
  try{ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }catch(e){ alert("Speichern im Ger√§t nicht m√∂glich."); }
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(LS_ITEMS);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) items = normalizeItems(parsed);
    }
  }catch(e){}
}
function saveSales(){
  try{ localStorage.setItem(LS_SALES, JSON.stringify(sales)); }catch(e){}
}
function loadSales(){
  try{
    const raw = localStorage.getItem(LS_SALES);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) sales = parsed;
    }
  }catch(e){}
}

function esc(s){
  return String(s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* ===== Layout ===== */
function adjust(){
  const topbar = $("topbar");
  const h = Math.ceil(topbar.getBoundingClientRect().height) + 6;
  document.documentElement.style.setProperty("--wrapTop", h + "px");
}
window.addEventListener("resize", adjust);
window.addEventListener("orientationchange", ()=>setTimeout(adjust, 80));

/* ===== Render ===== */
function render(){
  const table = $("table");
  table.innerHTML = "";
  items.forEach((a,i)=>{
    const hasNote = (a.note||"").trim().length>0;
    const hasPhoto = (a.photo||"").trim().length>0;

    const row = document.createElement("div");
    row.className = "gridRow" + ((Number(a.qty)||0)<=0 ? " zero" : "") + (a.id===selectedItemId ? " selected" : "");
    row.innerHTML = `
      <div class="cellNo" title="${esc(a.artNo || "")}">${esc(a.artNo || String(i+1).padStart(3,"0"))}</div>
      <div class="name cellName" title="${esc(a.name)}">${esc(a.name)}</div>
      <div><input class="qty" data-i="${i}" type="number" inputmode="numeric" value="${Number(a.qty)||0}"></div>
      <div class="small" title="${(Number(a.ek)||0).toFixed(2)}">${(Number(a.ek)||0).toFixed(2)}</div>
      <div class="small" title="${esc(a.date)}">${esc(a.date)}</div>
      <div class="small" title="${esc(a.shop)}">${esc(a.shop)}</div>
      <div class="small" title="${esc(a.size)}">${esc(a.size)}</div>
      <div class="small" title="${esc(a.state)}">${esc(a.state)}</div>
      <div class="icoBar">
        <div class="ico ${hasPhoto?'':'muted'}" data-act="photo" data-i="${i}" title="Foto">üì∑</div>
        <div class="ico ${hasNote?'':'muted'}" data-act="note" data-i="${i}" title="Notiz">üìù</div>
        <div class="ico" data-act="sale" data-i="${i}" title="Verkaufen">üõí</div>
        <div class="ico" data-act="edit" data-i="${i}" title="Bearbeiten">‚úèÔ∏è</div>
        <div class="ico danger" data-act="delItem" data-i="${i}" title="L√∂schen">üóëÔ∏è</div>
      </div>
    `;
    
    // Zeile anklicken => blau markieren (toggle), aber NICHT wenn man in Inputs/Icons klickt
    row.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(t && (t.closest("input") || t.closest(".ico"))) return;
      const id = a.id;
      selectedItemId = (selectedItemId === id) ? null : id;
      render();
    });
    table.appendChild(row);
  });

  table.querySelectorAll("input.qty").forEach(inp=>{
    inp.addEventListener("click", (ev)=>ev.stopPropagation());
    inp.addEventListener("change", (e)=>{
      const idx = Number(e.target.dataset.i);
      items[idx].qty = Number(e.target.value||0);
      saveLocal();
      render();
    });
  });

  table.querySelectorAll(".ico").forEach(ico=>{
    ico.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      const idx = Number(ico.dataset.i);
      const act = ico.dataset.act;
      if(act==="sale") { openSale(idx); return; }
      if(act==="delItem") { deleteItem(idx); return; }
      if(act==="photo") { openPhotoView(idx); return; }
      if(act==="note") { openNoteView(idx); return; }
      openEdit(idx, act);
    });
  });
}

/* ===== Artikel Modal ===== */
function resetPhotoUI(){
  $("mPhoto").value = "";
  if(modalPhotoData){
    $("photoImg").src = modalPhotoData;
    $("photoPreview").style.display = "block";
  }else{
    $("photoPreview").style.display = "none";
    $("photoImg").removeAttribute("src");
  }
}

function openEdit(i, act){
  editIndex = i;
  const a = items[i];
  $("modalTitle").textContent = "Artikel bearbeiten";
  $("mArtNo").value = a.artNo || "";
  $("mName").value = a.name||"";
  $("mQty").value = Number(a.qty)||0;
  $("mEK").value = Number(a.ek)||0;
  $("mDate").value = a.date||"";
  $("mShop").value = a.shop||"";
  $("mSize").value = a.size||"";
  $("mState").value = a.state||"Neu";
  $("mNote").value = a.note||"";
  modalPhotoData = a.photo||"";
  resetPhotoUI();
  $("modal").style.display = "block";
  if(act==="note") setTimeout(()=>$("mNote").scrollIntoView({behavior:"smooth",block:"center"}), 80);
  if(act==="photo") setTimeout(()=>$("mPhoto").scrollIntoView({behavior:"smooth",block:"center"}), 80);
}

function deleteItem(i){
  const a = items[i];
  if(!a) return;
  if(confirm("Artikel wirklich l√∂schen?")){
    items.splice(i,1);
    saveLocal();
    render();
  }
}


$("btnAdd").addEventListener("click", ()=>{
  editIndex = null;
  $("modalTitle").textContent = "Artikel anlegen";
  const y = String(new Date().getFullYear());
  $("mArtNo").value = nextItemNumber(y);
  $("mName").value=""; $("mQty").value=1; $("mEK").value=0;
  $("mDate").value=""; $("mShop").value=""; $("mSize").value=""; $("mState").value="Neu";
  $("mNote").value="";
  modalPhotoData="";
  resetPhotoUI();
  $("modal").style.display = "block";
});

$("mCancel").addEventListener("click", ()=>{ $("modal").style.display="none"; });

$("mPhoto").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ modalPhotoData = String(r.result||""); resetPhotoUI(); };
  r.readAsDataURL(f);
});

$("mSave").addEventListener("click", ()=>{
  const obj = {
    id: (editIndex===null ? (crypto.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2))) : (items[editIndex].id || (crypto.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2))))),
    artNo: ($("mArtNo").value||"").trim(),
    name: ($("mName").value||"").trim(),
    qty: Number($("mQty").value||0),
    ek: Number($("mEK").value||0),
    date: $("mDate").value||"",
    shop: ($("mShop").value||"").trim(),
    size: ($("mSize").value||"").trim(),
    state: $("mState").value||"Neu",
    note: ($("mNote").value||"").trim(),
    photo: modalPhotoData||""
  };
  if(!obj.name){ alert("Bitte Artikelname eingeben."); return; }
  if(!obj.artNo){
    const y = parseYearFromDate(obj.date) || String(new Date().getFullYear());
    obj.artNo = nextItemNumber(y);
  }
  if(editIndex===null) items.push(obj);
  else items[editIndex] = obj;
  saveLocal();
  $("modal").style.display="none";
  render();
});


function openPhotoView(i){
  const a = items[i];
  if(!a || !(a.photo||"").trim()){
    alert("Kein Foto hinterlegt.");
    return;
  }
  $("viewPhotoImg").src = a.photo;
  $("viewPhotoModal").style.display = "block";
}
function openNoteView(i){
  const a = items[i];
  if(!a || !(a.note||"").trim()){
    alert("Keine Notiz hinterlegt.");
    return;
  }
  $("viewNoteText").textContent = a.note;
  $("viewNoteModal").style.display = "block";
}
const _vpc=$("viewPhotoClose"); if(_vpc){ _vpc.addEventListener("click", ()=>{ $("viewPhotoModal").style.display="none"; }); }
const _vnc=$("viewNoteClose"); if(_vnc){ _vnc.addEventListener("click", ()=>{ $("viewNoteModal").style.display="none"; }); }
// Klick au√üerhalb der Box schlie√üt (iOS-Fallback)
const _vpnm=$("viewNoteModal");
if(_vpnm){ _vpnm.addEventListener("click",(ev)=>{ if(ev.target===_vpnm) _vpnm.style.display="none"; }); }
const _vppm=$("viewPhotoModal");
if(_vppm){ _vppm.addEventListener("click",(ev)=>{ if(ev.target===_vppm) _vppm.style.display="none"; }); }



/* ===== Verkauf ===== */

function findItemById(id){
  return items.find(x=>x.id===id);
}
function openSaleEdit(saleId){
  const s = sales.find(x=>x.id===saleId);
  if(!s) return;
  editSaleId = saleId;

  // Item may be missing (deleted)
  const item = findItemById(s.itemId);
  saleIndex = item ? items.indexOf(item) : null;

  $("saleTitle").textContent = "Verkauf bearbeiten" + (item ? (" ‚Äì " + (item.name||"")) : " ‚Äì (Artikel fehlt)");
  $("sDate").value = s.date || todayISO();
  $("sNumber").value = s.number || "";
  $("sPlace").value = s.place || "";
  $("sQty").value = Number(s.qty||0);
  $("sPrice").value = Number(s.price||0);
  $("sShip").value = Number(s.ship||0);
  $("sHint").textContent = item ? ("Bestand aktuell: " + (Number(item.qty)||0) + " (Bearbeiten passt Bestand an)") : "Artikel wurde gel√∂scht ‚Äì Bestand kann nicht angepasst werden.";
  $("saleModal").style.display = "block";
}

function parseYearFromDate(str){
  const m = String(str||"").match(/^(\d{4})/);
  return m ? m[1] : null;
}
function nextItemNumber(year){
  const y = String(year||new Date().getFullYear());
  // finde h√∂chste laufende Nummer im Jahr
  let max = 0;
  for(const it of items){
    const no = String(it.artNo||"");
    const mm = no.match(/^(\d{3,})-(\d{4})$/);
    if(mm && mm[2]===y){
      const n = Number(mm[1]);
      if(Number.isFinite(n) && n>max) max = n;
    }
  }
  const next = String(max+1).padStart(3,"0");
  return next + "-" + y;
}

function todayISO(){
  const d = new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}
function nextSaleNumber(dateStr){
  const year = (dateStr && dateStr.length>=4) ? dateStr.slice(0,4) : String(new Date().getFullYear());
  const count = sales.filter(s=>String(s.date||"").startsWith(year)).length + 1;
  return String(count).padStart(3,"0")+"-"+year;
}
function openSale(i){
  editSaleId = null;
  saleIndex = i;
  const a = items[i];
  const d = todayISO();
  $("saleTitle").textContent = "Verkauf ‚Äì " + String(i+1).padStart(3,"0") + " ‚Äì " + (a.name||"");
  $("sDate").value = d;
  $("sNumber").value = nextSaleNumber(d);
  $("sPlace").value = "";
  $("sQty").value = Math.min(1, Number(a.qty||0) || 0);
  $("sPrice").value = 0;
  $("sShip").value = 0;
  $("sHint").textContent = "Bestand aktuell: " + (Number(a.qty)||0);
  $("saleModal").style.display="block";
}
$("sCancel").addEventListener("click", ()=>{ $("saleModal").style.display="none"; });

$("sSave").addEventListener("click", ()=>{
  const qty = Number($("sQty").value||0);
  if(!qty || qty<=0){ alert("Bitte Menge > 0 eingeben."); return; }

  // EDIT MODE
  if(editSaleId){
    const idxSale = sales.findIndex(x=>x.id===editSaleId);
    if(idxSale===-1){ alert("Verkauf nicht gefunden."); return; }
    const old = sales[idxSale];
    if(old.storno){ alert("Stornierte Verk√§ufe k√∂nnen nicht bearbeitet werden."); return; }

    const item = findItemById(old.itemId);
    // Bestand: zuerst alten Verkauf zur√ºck, dann neuen abziehen (wenn Artikel existiert)
    if(item){
      const oldQty = Number(old.qty||0);
      item.qty = Number(item.qty||0) + oldQty;

      const current = Number(item.qty||0);
      if(qty>current){
        // rollback old restore? actually we already restored; just show error and keep restored -> revert back to old state
        item.qty = current - oldQty;
        alert("Menge zu hoch. Bestand: " + (current));
        return;
      }
      item.qty = current - qty;
      saveLocal();
    }

    sales[idxSale] = {
      ...old,
      number: ($("sNumber").value||"").trim() || old.number,
      date: $("sDate").value || old.date || todayISO(),
      place: ($("sPlace").value||"").trim(),
      qty: qty,
      price: Number($("sPrice").value||0),
      ship: Number($("sShip").value||0)
    };
    saveSales();
    $("saleModal").style.display="none";
    editSaleId = null;
    render();
    renderSales();
    return;
  }

  // NEW SALE MODE
  if(saleIndex===null){ alert("Artikel nicht gefunden."); return; }
  const a = items[saleIndex];
  const current = Number(a.qty||0);
  if(qty>current){ alert("Menge zu hoch. Bestand: "+current); return; }

  const rec = {
    id: (crypto.randomUUID ? crypto.randomUUID() : ("sid_"+Math.random().toString(16).slice(2))),
    itemId: a.id,
    storno: false,
    number: ($("sNumber").value||"").trim() || nextSaleNumber($("sDate").value||todayISO()),
    date: $("sDate").value || todayISO(),
    place: ($("sPlace").value||"").trim(),
    itemName: a.name||"",
    qty: qty,
    price: Number($("sPrice").value||0),
    ship: Number($("sShip").value||0),
    ek: Number(a.ek||0)
  };
  sales.push(rec);
  a.qty = current - qty;
  saveLocal(); saveSales();
  $("saleModal").style.display="none";
  render();
});


/* ===== Verk√§ufe √úbersicht ===== */
function renderSales(){
  const el = $("salesList");
  const q = ($("salesSearch")?.value || "").trim().toLowerCase();
  el.innerHTML = "";
  if(!sales.length){
    el.innerHTML = '<div style="color:#aaa;font-size:9px;padding:6px">Noch keine Verk√§ufe gespeichert.</div>';
    return;
  }
  const arr = [...sales].slice().reverse().filter(s=>{
    if(!q) return true;
    const hay = (String(s.number||"")+" "+String(s.date||"")+" "+String(s.itemName||"")+" "+String(s.place||"")).toLowerCase();
    return hay.includes(q);
  });

  if(!arr.length){
    el.innerHTML = '<div style="color:#aaa;font-size:9px;padding:6px">Keine Treffer.</div>';
    return;
  }

  arr.forEach(s=>{
    const row = document.createElement("div");
    row.style.display="grid";
    row.style.gridTemplateColumns="90px 86px 1fr 52px 70px 120px 78px";
    row.style.gap="4px";
    row.style.fontSize="9px";
    row.style.whiteSpace="nowrap";
    row.style.padding="3px 0";
    row.style.borderBottom="1px solid #222";

    const status = s.storno ? " (Storno)" : "";
    row.innerHTML = `
      <div>${esc(s.number||"")}${status}</div>
      <div>${esc(s.date||"")}</div>
      <div title="${esc(s.itemName||"")}">${esc(s.itemName||"")}</div>
      <div>${Number(s.qty||0)}</div>
      <div>${(Number(s.price||0)).toFixed(2)}</div>
      <div title="${esc(s.place||"")}">${esc(s.place||"")}</div>
      <div style="display:flex;gap:4px;justify-content:flex-end">
        <div class="ico" data-sact="edit" data-sid="${esc(s.id)}" title="Bearbeiten">‚úèÔ∏è</div>
        <div class="ico" data-sact="storno" data-sid="${esc(s.id)}" title="Storno">‚Ü©Ô∏è</div>
        <div class="ico danger" data-sact="del" data-sid="${esc(s.id)}" title="L√∂schen">üóëÔ∏è</div>
      </div>
    `;
    el.appendChild(row);
  });

  // actions
  el.querySelectorAll(".ico").forEach(btn=>{
    const act = btn.getAttribute("data-sact");
    const sid = btn.getAttribute("data-sid");
    if(!act || !sid) return;
    btn.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      if(act==="edit"){ openSaleEdit(sid); return; }
      if(act==="storno"){ stornoSale(sid); return; }
      if(act==="del"){ deleteSale(sid); return; }
    });
  });
}

function stornoSale(sid){
  const idx = sales.findIndex(x=>x.id===sid);
  if(idx===-1) return;
  const s = sales[idx];
  if(s.storno) return;

  const item = findItemById(s.itemId);
  if(item){
    item.qty = Number(item.qty||0) + Number(s.qty||0);
    saveLocal();
  }
  s.storno = true;
  saveSales();
  render();
  renderSales();
}

function deleteSale(sid){
  const idx = sales.findIndex(x=>x.id===sid);
  if(idx===-1) return;
  const s = sales[idx];
  if(confirm("Verkauf wirklich l√∂schen?")){
    if(!s.storno){
      const item = findItemById(s.itemId);
      if(item){
        item.qty = Number(item.qty||0) + Number(s.qty||0);
        saveLocal();
      }
    }
    sales.splice(idx,1);
    saveSales();
    render();
    renderSales();
  }
}

const _salesSearch = $("salesSearch");
if(_salesSearch){ _salesSearch.addEventListener("input", ()=>renderSales()); }

$("btnSalesTop").addEventListener("click", ()=>{ renderSales(); $("salesModal").style.display="block"; });
const _salesClose=$("salesClose"); if(_salesClose){ _salesClose.addEventListener("click", ()=>{ $("salesModal").style.display="none"; }); }

/* ===== Export / Import ===== */
$("btnSave").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lager_backup.json";
  a.click();
});

$("btnLoad").addEventListener("click", ()=>{
  const inp = document.createElement("input");
  inp.type = "file";
  // JSON Backups (empfohlen) oder alte HTML-Versionen (best-effort)
  inp.accept = ".json,application/json,.html,text/html";
  inp.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;

    const name = (f.name || "").toLowerCase();
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const text = String(r.result || "");

        let arr = null;

        if(name.endsWith(".html")){
          // Versuche, ein Items-Array direkt aus dem HTML zu ziehen
          arr = extractItemsFromHTMLText(text);
          if(!arr) throw new Error("HTML-Import: kein Items-Array gefunden");
        }else{
          const parsed = JSON.parse(text);
          arr = extractItems(parsed);
          if(!arr) throw new Error("Format falsch");
        }

        // Wichtig: vorhandene Artikelnummern werden √ºbernommen (artNo/nr/artikelnummer/...)
        items = normalizeItems(arr);
        saveLocal();
        render();
      }catch(err){
        alert("Datei konnte nicht gelesen werden. Tipp: Bitte aus der alten App als JSON exportieren und hier laden.");
      }
    };
    r.readAsText(f);
  };
  inp.click();
});

$("btnPDF").addEventListener("click", ()=>{
  alert("PDF kommt als n√§chster Schritt.");
});

/* Init */
loadLocal();
loadSales();
// Migration: IDs + Artikelnummern nachziehen (aus alten Backups)
items = items.map(x=>({
  id: x.id || (crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(16).slice(2))),
  ...x
}));

// fehlende Artikelnummern: pro Jahr fortlaufend vergeben (jahr aus Kaufdatum, sonst aktuelles Jahr)
const yearCounters = {};
for(const it of items){
  if(!it.artNo){
    const y = parseYearFromDate(it.date) || String(new Date().getFullYear());
    yearCounters[y] = (yearCounters[y]||0) + 1;
    it.artNo = String(yearCounters[y]).padStart(3,"0") + "-" + y;
  }
}
saveLocal();
selectedItemId = null;
render();
adjust();
setTimeout(adjust, 0);
setTimeout(adjust, 250);

</script>

<!-- Foto ansehen -->
<div id="viewPhotoModal">
  <div class="box">
    <h3 style="margin:0 0 6px;font-size:12px">Foto</h3>
    <div class="preview" id="viewPhotoPreview" style="display:block">
      <img id="viewPhotoImg" alt="Foto">
    </div>
    <div class="btnRow">
      <button id="viewPhotoClose">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Notiz ansehen -->
<div id="viewNoteModal">
  <div class="box">
    <h3 style="margin:0 0 6px;font-size:12px">Notiz</h3>
    <div style="border:1px solid #333;border-radius:10px;padding:8px;background:#111;font-size:10px;white-space:pre-wrap" id="viewNoteText"></div>
    <div class="btnRow">
      <button id="viewNoteClose">Schlie√üen</button>
    </div>
  </div>
</div>

</body>
</html>
